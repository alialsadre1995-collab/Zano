<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Ø´Ø§Øª Ø§Ù„Ø¹Ø±Ø¨</title>
<style>
:root{--bg:#0b0b0f;--fg:#e7e7ea;--muted:#9ca3af;--card:#14141b;--border:#2a2a38;--accent:#6ee7b7;--danger:#ef4444}
*{box-sizing:border-box} html,body{height:100dvh} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto;-webkit-overflow-scrolling:touch}
.wrap{max-width:740px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
header.app{position:sticky;top:0;background:var(--bg);padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;z-index:10}
.title{font-weight:700}
.icons{display:flex;gap:10px}
.iconbtn{background:var(--card);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px;cursor:pointer}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
input,button{background:#101016;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:12px}
button{cursor:pointer}
.muted{color:var(--muted)}
.login{padding:16px;display:flex;flex-direction:column;gap:14px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:520px){ .grid{grid-template-columns:1fr 1fr} }
.chat{display:flex;flex-direction:column;gap:10px;padding:12px}
.messages{flex:1;min-height:48vh;max-height:58vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:#0e0e14}
.msg{margin-bottom:8px}
.meta{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center}
.name{font-weight:600}
.bubble{display:inline-block;margin-top:4px;background:#12121a;border:1px solid var(--border);padding:10px;border-radius:12px;max-width:95%}
.system{color:#cbd5e1;font-style:italic}
.composerBar{position:fixed;left:0;right:0;bottom:0;max-width:740px;margin:0 auto;background:var(--bg);padding:10px 12px calc(10px + env(safe-area-inset-bottom));border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;z-index:15}
.composerBar input{flex:1}
.presence{display:flex;gap:6px;overflow:auto}
.presence .user{border:1px solid var(--border);border-radius:999px;padding:6px 8px;font-size:12px;white-space:nowrap}
.spacer{height:100px} /* Ù…Ø³Ø§Ø­Ø© ØªØ­Øª Ù„Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ */

.panel{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;z-index:50}
.panel .inner{background:#0d0d12;border-top:1px solid var(--border);width:100%;max-width:740px;margin:0 auto;border-radius:12px 12px 0 0;padding:12px;max-height:80vh;overflow:auto}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
.danger{border-color:#7f1d1d;color:#fecaca}

/* Ù†Ø§ÙØ°Ø© DM Ø¹Ø§Ø¦Ù…Ø© */
.dm{position:fixed;bottom:90px;right:10px;width:320px;max-width:90vw;background:#0d0d12;border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:none;flex-direction:column;z-index:40}
.dmHeader{display:flex;align-items:center;justify-content:space-between;background:#14141b;border-bottom:1px solid var(--border);padding:8px 10px;border-radius:10px 10px 0 0}
.dmTitle{font-weight:600}
.dmBtns button{padding:6px 8px}
.dmBody{max-height:40vh;overflow:auto;background:#0e0e14;padding:10px}
.dmComposer{display:flex;gap:8px;padding:8px;border-top:1px solid var(--border)}
.dmMax{inset:0 !important;position:fixed !important;width:auto !important;height:auto !important;max-width:none !important;border-radius:0 !important}
</style>
</head>
<body>
<div class="wrap">
  <header class="app">
    <div class="title">ØºØ±ÙÙ‡ Ø§Ù„Ø¹Ø±Ø¨</div>
    <div class="icons">
      <button class="iconbtn" id="iconAdmin" type="button">ğŸ›¡ï¸</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="login" class="login">
    <div class="grid">
      <div class="card">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Ø¬ÙˆØ§Ù„)</h3>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø·)</label>
        <input id="u" placeholder="Guest123">
        <button id="loginQuick" type="button">Ø¯Ø®ÙˆÙ„</button>
        <p class="muted">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙŠØªØ­ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Guest.</p>
      </div>
      <div class="card">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h3>
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input id="au" value="Admin">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
        <input id="ap" type="password" value="1200@">
        <button id="loginAdmin" type="button">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</button>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chat" class="chat" style="display:none">
    <div class="presence" id="presence"></div>
    <div class="messages" id="messages"></div>
    <div class="spacer"></div>
  </section>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø«Ø§Ø¨Øª -->
  <div class="composerBar" id="composer" style="display:none">
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§">
    <button id="send" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¨Ø³ÙŠØ·Ø©) -->
  <div id="adminPanel" class="panel">
    <div class="inner">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong>
        <div class="row">
          <button class="iconbtn" id="btnRefreshAdmin" type="button">ØªØ­Ø¯ÙŠØ«</button>
          <button class="iconbtn" id="closeAdmin" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div id="adminList"></div>
      <div class="row" style="margin-top:8px">
        <div class="pill">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±</div>
      </div>
      <div id="banList"></div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© DM Ø¹Ø§Ø¦Ù…Ø© -->
  <div class="dm" id="dmWin">
    <div class="dmHeader">
      <div class="dmTitle" id="dmTitle">Ø®Ø§Øµ</div>
      <div class="dmBtns">
        <button id="dmMin" class="iconbtn" type="button">â€”</button>
        <button id="dmMax" class="iconbtn" type="button">â¤¢</button>
        <button id="dmClose" class="iconbtn" type="button">âœ•</button>
      </div>
    </div>
    <div class="dmBody" id="dmBody"></div>
    <div class="dmComposer">
      <input id="dmInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©â€¦">
      <button id="dmSend" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

</div>

<script>
const state = {
  base: location.origin,
  token: null, me: null, socket: null,
  selectedUser: null, role:'user', color:'#fff',
  dmWith: null, dmMax: false
};
const $ = s => document.querySelector(s);
const el = (t,cls) => { const x=document.createElement(t); if(cls) x.className=cls; return x; };
const deviceId = ()=>{ let id = localStorage.getItem('deviceId'); if(!id){ id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2); localStorage.setItem('deviceId',id);} return id; };

async function post(path, body, auth=true){
  const h = {'Content-Type':'application/json'}; 
  if (auth && state.token) h['Authorization']='Bearer '+state.token;
  const res = await fetch(state.base + path, { method:'POST', headers:h, body: JSON.stringify(body||{}) });
  const data = await res.json(); if (data.error) throw new Error(data.error); return data;
}
async function get(path, auth=true){
  const h = {}; if (auth && state.token) h['Authorization']='Bearer '+state.token;
  const res = await fetch(state.base + path, { headers:h }); const data = await res.json(); if (data.error) throw new Error(data.error); return data;
}

function setLoggedIn(me){
  state.me = me; state.role = me.role; state.color = me.color || '#fff';
  $('#login').style.display = 'none';
  $('#chat').style.display = 'flex';
  $('#composer').style.display = 'flex';
  $('#msg').focus();
}

function pushSystem(text){
  const wrap = el('div','msg system');
  wrap.textContent = text;
  $('#messages').appendChild(wrap);
  $('#messages').scrollTop = $('#messages').scrollHeight;
}

function pushMessage(m){
  const wrap = el('div','msg');
  const meta = el('div','meta');
  const name = el('span','name'); name.textContent = m.from; name.style.color = m.color || '#fff'; name.style.direction='ltr'; name.style.cursor='pointer';
  name.onclick = ()=> openUserMenu(m.userId, m.from);
  meta.appendChild(name);
  const ts = el('span'); ts.textContent = new Date(m.ts).toLocaleTimeString(); meta.appendChild(ts);
  wrap.appendChild(meta);
  const bubble = el('div','bubble'); bubble.textContent = m.text; wrap.appendChild(bubble);
  $('#messages').appendChild(wrap); $('#messages').scrollTop = $('#messages').scrollHeight;
}

function renderPresence(list){
  const area=$('#presence'); area.innerHTML='';
  list.forEach(u=>{
    const badge=el('div','user'); badge.textContent=u.username; badge.style.color=u.color||'#fff'; badge.style.direction='ltr';
    badge.onclick = ()=> openUserMenu(u.userId, u.username);
    area.appendChild(badge);
  });
}

function openUserMenu(userId, username){
  const isAdmin = (state.role==='admin'||state.role==='mod');
  const wrap = el('div','panel'); const inner = el('div','inner'); wrap.appendChild(inner);
  const row = el('div','row'); inner.appendChild(row);
  const mkBtn = (t,fn,klass='iconbtn')=>{ const b=el('button',klass); b.textContent=t; b.onclick=()=>{document.body.removeChild(wrap); fn();}; return b; };

  row.appendChild(el('div')); row.lastChild.textContent = `Ø§Ù„Ø¹Ø¶Ùˆ: ${username}`;
  const btnReply = mkBtn('Ø±Ø¯', ()=>{ const t=prompt('Ù†Øµ Ø§Ù„Ø±Ø¯:'); if(!t) return; state.socket.emit('chat:reply',{ text:t, ref: 'any' }); });
  const btnDm = mkBtn('Ø®Ø§Øµ', ()=> openDM(userId, username));
  inner.append(btnReply, btnDm);

  if (isAdmin){
    const adminRow = el('div','row'); adminRow.style.marginTop='8px';
    adminRow.appendChild(mkBtn('Ø·Ø±Ø¯', ()=> adminKick(userId)));
    adminRow.appendChild(mkBtn('Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²', ()=> adminBan(userId,'deviceId')));
    adminRow.appendChild(mkBtn('Ø­Ø¸Ø± IP', ()=> adminBan(userId,'ip'),'iconbtn danger'));
    inner.appendChild(adminRow);
  }
  wrap.onclick = (e)=>{ if (e.target===wrap) document.body.removeChild(wrap); };
  document.body.appendChild(wrap); wrap.style.display='flex';
}

async function adminKick(userId){
  const list = await get('/api/admin/online', true);
  const u = list.find(x=>x.userId===userId); if (!u) return alert('ØºÙŠØ± Ù…ØªØµÙ„');
  await post('/api/admin/kick',{ deviceId:u.deviceId, reason:'by admin' }, true);
}
async function adminBan(userId, kind){
  const list = await get('/api/admin/online', true);
  const u = list.find(x=>x.userId===userId); if (!u) return alert('ØºÙŠØ± Ù…ØªØµÙ„');
  if (kind==='deviceId'){
    // ÙŠÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ÙŠØ­Ø¸Ø± (Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠÙ†ÙØ° Ø°Ù„Ùƒ)
    await post('/api/admin/ban',{ targetType:'deviceId', targetValue:u.deviceId, reason:'by admin', minutes:0 }, true);
  } else {
    await post('/api/admin/ban',{ targetType:'ip', targetValue:u.ip, reason:'by admin', minutes:0 }, true);
  }
}

function openDM(userId, username){
  state.dmWith = { userId, username };
  $('#dmTitle').textContent = `Ø®Ø§Øµ: ${username}`;
  $('#dmBody').innerHTML = '';
  $('#dmWin').style.display='flex';
  $('#dmInput').focus();
}
$('#dmSend').onclick = ()=>{ const t=$('#dmInput').value.trim(); if(!t||!state.dmWith) return; state.socket.emit('dm:send',{ toId: state.dmWith.userId, text:t}); $('#dmInput').value=''; $('#dmInput').focus(); };
$('#dmClose').onclick = ()=> $('#dmWin').style.display='none';
$('#dmMin').onclick = ()=> $('#dmWin').style.display='none';
$('#dmMax').onclick = ()=>{ state.dmMax = !state.dmMax; $('#dmWin').classList.toggle('dmMax', state.dmMax); };

$('#iconAdmin').onclick = async ()=>{
  if (state.role!=='admin' && state.role!=='mod'){ alert('Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
  await loadAdmin(); $('#adminPanel').style.display='flex';
};
$('#closeAdmin').onclick = ()=> $('#adminPanel').style.display='none';
$('#btnRefreshAdmin').onclick = ()=> loadAdmin();

async function loadAdmin(){
  const list = await get('/api/admin/online', true);
  const wrap = $('#adminList'); wrap.innerHTML='';
  list.forEach(u=>{
    const card = el('div','card'); card.style.marginBottom='8px';
    card.innerHTML = `<div class="row" style="justify-content:space-between"><strong style="color:${u.color};direction:ltr">${u.username}</strong><span class="pill">role: ${u.role}</span></div>
      <div class="muted">deviceId: ${u.deviceId || '-'} Â· IP: ${u.ip || '-'}</div>`;
    const actions = el('div','row');
    const k = el('button','iconbtn'); k.textContent='Ø·Ø±Ø¯'; k.onclick=()=> post('/api/admin/kick',{deviceId:u.deviceId,reason:'admin'},true).then(()=>alert('ØªÙ… Ø§Ù„Ø·Ø±Ø¯'));
    const b1 = el('button','iconbtn danger'); b1.textContent='Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²'; b1.onclick=()=> post('/api/admin/ban',{targetType:'deviceId',targetValue:u.deviceId,reason:'admin',minutes:0},true).then(()=>alert('ØªÙ… Ø§Ù„Ø­Ø¸Ø±'));
    const b2 = el('button','iconbtn danger'); b2.textContent='Ø­Ø¸Ø± IP'; b2.onclick=()=> post('/api/admin/ban',{targetType:'ip',targetValue:u.ip,reason:'admin',minutes:0},true).then(()=>alert('ØªÙ… Ø§Ù„Ø­Ø¸Ø±'));
    actions.append(k,b1,b2); card.appendChild(actions); wrap.appendChild(card);
  });

  const bans = await get('/api/admin/bans', true);
  const bwrap = $('#banList'); bwrap.innerHTML='';
  bans.forEach(b=>{
    const row = el('div','card'); row.style.marginBottom='8px';
    row.innerHTML = `<div class="row"><span class="pill">Ø§Ù„Ù†ÙˆØ¹: ${b.type}</span><span class="pill">Ø§Ù„Ù…ÙØªØ§Ø­: ${b.key}</span></div>
    <div class="muted">Ø§Ù„Ø³Ø¨Ø¨: ${b.reason||'-'} Â· Ù…Ù†Ø°: ${new Date(b.createdAt).toLocaleString()} ${b.expiresAt?('Â· ÙŠÙ†ØªÙ‡ÙŠ: '+new Date(b.expiresAt).toLocaleString()):''}</div>`;
    const un = el('button','iconbtn'); un.textContent='ÙÙƒ Ø§Ù„Ø­Ø¸Ø±'; un.onclick=()=> post('/api/admin/unban',{key:b.key},true).then(()=>loadAdmin());
    row.appendChild(un); bwrap.appendChild(row);
  });
}

// Ø¥Ø±Ø³Ø§Ù„
$('#send').onclick = sendMsg;
$('#msg').addEventListener('keydown', e=>{
  if (e.key === 'Enter'){ e.preventDefault(); sendMsg(); }
});
function sendMsg(){
  const t=$('#msg').value.trim(); if(!t) return;
  state.socket.emit('chat:msg', { text:t });
  $('#msg').value=''; $('#msg').focus(); // ÙŠØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù…ÙØªÙˆØ­
}

// Ø¯Ø®ÙˆÙ„
$('#loginQuick').onclick = ()=> doLogin('user');
$('#loginAdmin').onclick = ()=> doLogin('admin');
async function doLogin(kind){
  try{
    let data;
    if (kind==='admin'){
      data = await post('/api/login-pass', { username: $('#au').value.trim(), password: $('#ap').value, deviceId: deviceId() }, false);
    } else {
      data = await post('/api/login', { username: $('#u').value.trim(), deviceId: deviceId() }, false);
    }
    state.token = data.token;
    setLoggedIn({ username:data.username, role:data.role, color:data.color });
    await loadSocketClient();
    connectSocket();
  }catch(e){ alert(e.message || 'login failed'); }
}

function loadSocketClient(){
  return new Promise((resolve,reject)=>{
    if (window.io) return resolve();
    const s = document.createElement('script');
    s.src = state.base + '/socket.io/socket.io.js';
    s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

function connectSocket(){
  state.socket = io(state.base, { auth: { token: state.token } });
  state.socket.on('history', arr => { $('#messages').innerHTML=''; arr.forEach(pushMessage); });
  state.socket.on('chat:new', pushMessage);
  state.socket.on('presence', renderPresence);
  state.socket.on('admin:clear', ()=> $('#messages').innerHTML='');
  state.socket.on('dm:new', rec => {
    if (state.dmWith && (rec.fromId===state.dmWith.userId || rec.toId===state.dmWith.userId)){
      const line = el('div'); line.textContent = (rec.fromId===state.dmWith.userId? state.dmWith.username : 'Ø£Ù†Ø§') + ': ' + rec.text;
      $('#dmBody').appendChild(line);
      $('#dmBody').scrollTop = $('#dmBody').scrollHeight;
    }
  });
  // Ø±Ø³Ø§Ø¦Ù„ Ù†Ø¸Ø§Ù…: join / kick / ban
  state.socket.on('system', m => { if (m?.text) pushSystem(m.text); });
  state.socket.on('banned', info => { alert((info && info.reason) || 'banned'); state.socket.disconnect(); });
}
</script>
</body>
</html>
