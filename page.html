<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>شات العرب</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{--bg:#0b0b0f;--fg:#e7e7ea;--muted:#9ca3af;--card:#14141b;--border:#2a2a38;--accent:#6ee7b7;--danger:#ef4444}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, Segoe UI, Roboto}
    .wrap{max-width:720px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
    header.app{position:sticky;top:0;background:var(--bg);padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;z-index:10}
    header.app .title{font-weight:700}
    header.app .icons{display:flex;gap:10px}
    .iconbtn{background:var(--card);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    input,button,select,textarea{background:#101016;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:12px}
    button{cursor:pointer}
    .muted{color:var(--muted)}
    .login{padding:16px;display:flex;flex-direction:column;gap:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:520px){ .grid{grid-template-columns:1fr 1fr} }
    .chat{display:flex;flex-direction:column;gap:12px;padding:12px}
    .roomBanner{display:flex;align-items:center;gap:8px}
    .messages{flex:1;min-height:50vh;max-height:55vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:#0e0e14}
    .msg{margin-bottom:8px}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center}
    .name{font-weight:600}
    .bubble{display:inline-block;margin-top:4px;background:#12121a;border:1px solid var(--border);padding:10px;border-radius:12px;max-width:95%}
    .composer{position:sticky;bottom:0;display:flex;gap:8px;align-items:center}
    .composer input{flex:1}
    .presence{display:flex;gap:6px;overflow:auto}
    .presence .user{border:1px solid var(--border);border-radius:999px;padding:6px 8px;font-size:12px;white-space:nowrap}
    /* Panels */
    .panel{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;z-index:50}
    .panel .inner{background:#0d0d12;border-top:1px solid var(--border);width:100%;max-width:720px;margin:0 auto;border-radius:12px 12px 0 0;padding:12px;max-height:80vh;overflow:auto}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
    .danger{border-color:#7f1d1d;color:#fecaca}
    .section-title{margin:12px 0 6px;font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <header class="app">
    <div class="title">غرفه العرب</div>
    <div class="icons">
      <button class="iconbtn" id="iconAdmin" type="button">🛡️</button>
      <button class="iconbtn" id="iconDM" type="button">💬</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="login" class="login">
    <div class="grid">
      <div class="card">
        <h3>تسجيل دخول (جوال)</h3>
        <label>اسم المستخدم (إنجليزي فقط):</label>
        <input id="u" placeholder="Guest123">
        <button id="loginQuick" type="button">دخول</button>
        <p class="muted">سيتحوّل الاسم العربي تلقائيًا إلى Guest.</p>
      </div>
      <div class="card">
        <h3>دخول المشرف</h3>
        <label>الاسم</label>
        <input id="au" value="Admin">
        <label>كلمة السر</label>
        <input id="ap" type="password" value="1200@">
        <button id="loginAdmin" type="button">دخول المشرف</button>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chat" class="chat" style="display:none">
    <div class="roomBanner">
      <span id="me" class="muted"></span>
      <span class="pill">غرفة واحدة: غرفه العرب</span>
    </div>

    <div class="presence" id="presence"></div>
    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="msg" placeholder="اكتب رسالة...">
      <button id="send" type="button">إرسال</button>
    </div>
  </section>

  <!-- DM PANEL -->
  <section id="dmPanel" class="panel">
    <div class="inner">
      <div class="row" style="justify-content:space-between">
        <strong id="dmTitle">خاص مع …</strong>
        <button class="iconbtn" id="closeDM" type="button">إغلاق</button>
      </div>
      <div id="dmMsgs" class="messages" style="max-height:35vh"></div>
      <div class="row">
        <input id="dmInput" placeholder="اكتب رسالة خاصة..." style="flex:1">
        <button id="dmSend" type="button">إرسال</button>
      </div>
    </div>
  </section>

  <!-- ACTION SHEET (reply/DM) -->
  <div id="sheet" class="panel">
    <div class="inner" style="padding-bottom:24px">
      <div class="row" id="sheetBtns"></div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="panel">
    <div class="inner">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>لوحة الإدارة</strong>
        <div class="row">
          <button class="iconbtn" id="btnRefreshAdmin" type="button">تحديث</button>
          <button class="iconbtn danger" id="btnClearChat" type="button">مسح الدردشة</button>
          <button class="iconbtn" id="closeAdmin" type="button">إغلاق</button>
        </div>
      </div>

      <div class="section-title">المتصلون الآن</div>
      <div id="adminList"></div>

      <div class="section-title">قائمة الحظر</div>
      <div id="banList"></div>
    </div>
  </div>

</div>

<script>
const state = {
  base: location.origin,
  token: null, me: null, socket: null,
  selectedUser: null, dmWith: null, role: 'user', color:'#fff'
};
const $ = s => document.querySelector(s);
const el = (t,cls) => { const x=document.createElement(t); if(cls) x.className=cls; return x; };
const deviceId = ()=>{ let id = localStorage.getItem('deviceId'); if(!id){ id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2); localStorage.setItem('deviceId',id);} return id; };

async function post(path, body, auth=true){
  const h = {'Content-Type':'application/json'}; 
  if (auth && state.token) h['Authorization']='Bearer '+state.token;
  const res = await fetch(state.base + path, { method:'POST', headers:h, body: JSON.stringify(body||{}) });
  const data = await res.json(); if (data.error) throw new Error(data.error); return data;
}
async function get(path, auth=true){
  const h = {}; if (auth && state.token) h['Authorization']='Bearer '+state.token;
  const res = await fetch(state.base + path, { headers:h }); const data = await res.json(); if (data.error) throw new Error(data.error); return data;
}

function setLoggedIn(me){
  state.me = me; state.role = me.role; state.color = me.color || '#fff';
  $('#me').textContent = `أنت: ${me.username} · الدور: ${me.role}`;
  $('#login').style.display = 'none';
  $('#chat').style.display = 'flex';
}

function pushMessage(m){
  const wrap = el('div','msg');
  const meta = el('div','meta');
  const name = el('span','name'); name.textContent = m.from; name.style.color = m.color || '#fff'; name.style.direction='ltr'; name.style.cursor='pointer';
  name.onclick = ()=> openSheetForUser(m.userId, m.from, m);
  meta.appendChild(name);
  const ts = el('span'); ts.textContent = new Date(m.ts).toLocaleTimeString(); meta.appendChild(ts);
  wrap.appendChild(meta);
  const bubble = el('div','bubble'); bubble.textContent = m.text; wrap.appendChild(bubble);
  if (m.ref){ const ref = el('div','muted'); ref.textContent='↩ رد على رسالة'; wrap.appendChild(ref); }
  $('#messages').appendChild(wrap); $('#messages').scrollTop = $('#messages').scrollHeight;
}

function openSheetForUser(userId, username, message){
  state.selectedUser = { userId, username, message };
  const panel = $('#sheet'); const btns = $('#sheetBtns'); btns.innerHTML='';
  const addBtn = (txt, fn)=>{ const b=el('button','iconbtn'); b.type='button'; b.textContent=txt; b.onclick=()=>{panel.style.display='none'; fn();}; btns.appendChild(b); };
  addBtn('رد على الرسالة', ()=>{ const ref=message?.mid; const t=prompt('اكتب ردّك:'); if(!t||!ref) return; state.socket.emit('chat:reply', { text:t, ref }); });
  addBtn('دخول خاص', ()=> openDM(userId, username));
  panel.style.display='flex';
}
$('#sheet').onclick = (e)=>{ if (e.target.id==='sheet') e.currentTarget.style.display='none'; };

function openDM(userId, username){ state.dmWith = { userId, username }; $('#dmTitle').textContent = `خاص مع: ${username}`; $('#dmPanel').style.display='flex'; }
$('#closeDM').onclick = ()=> $('#dmPanel').style.display='none';
$('#dmSend').onclick = ()=>{ const t=$('#dmInput').value.trim(); if(!t||!state.dmWith) return; state.socket.emit('dm:send', { toId: state.dmWith.userId, text: t }); $('#dmInput').value=''; };

function renderPresence(list){
  const box=$('#presence'); box.innerHTML='';
  list.forEach(u=>{ const badge=el('div','user'); badge.textContent=u.username; badge.style.color=u.color||'#fff'; badge.style.direction='ltr'; badge.onclick=()=>openSheetForUser(u.userId, u.username, null); box.appendChild(badge); });
}

// Admin UI
$('#iconAdmin').onclick = async ()=>{
  if (state.role!=='admin' && state.role!=='mod'){ alert('هذه القائمة للمشرف فقط'); return; }
  await loadAdmin();
  $('#adminPanel').style.display='flex';
};
$('#closeAdmin').onclick = ()=> $('#adminPanel').style.display='none';
$('#btnRefreshAdmin').onclick = ()=> loadAdmin();
$('#btnClearChat').onclick = async ()=>{ await post('/api/admin/clear', {}, true); alert('تم مسح الدردشة'); };

async function loadAdmin(){
  // المتصلون
  const list = await get('/api/admin/online', true);
  const wrap = $('#adminList'); wrap.innerHTML='';
  if (!list.length){ wrap.textContent='لا يوجد متصلون.'; }
  list.forEach(u=>{
    const card = el('div','card'); card.style.marginBottom='8px';
    const head = el('div','row'); head.innerHTML = `<strong style="color:${u.color};direction:ltr">${u.username}</strong> <span class="pill">role: ${u.role}</span>`;
    const info = el('div','muted'); info.textContent = `deviceId: ${u.deviceId || '-'} · IP: ${u.ip || '-'}`;
    const actions = el('div','row');
    const btnKick = el('button','iconbtn'); btnKick.type='button'; btnKick.textContent='طرد'; btnKick.onclick = ()=> post('/api/admin/kick', { deviceId: u.deviceId }, true).then(()=>alert('تم الطرد'));
    const btnBanDev = el('button','iconbtn danger'); btnBanDev.type='button'; btnBanDev.textContent='حظر جهاز'; btnBanDev.onclick = ()=> post('/api/admin/ban', { targetType:'deviceId', targetValue: u.deviceId, reason:'admin', minutes:0 }, true).then(()=>alert('تم الحظر'));
    const btnBanIp = el('button','iconbtn danger'); btnBanIp.type='button'; btnBanIp.textContent='حظر IP'; btnBanIp.onclick = ()=> post('/api/admin/ban', { targetType:'ip', targetValue: u.ip, reason:'admin', minutes:0 }, true).then(()=>alert('تم الحظر'));
    const btnInfo = el('button','iconbtn'); btnInfo.type='button'; btnInfo.textContent='كشف معلومات'; btnInfo.onclick = async ()=>{ const d = await get('/api/admin/user-info?userId='+encodeURIComponent(u.userId), true); alert(`userId: ${d.userId}\nusername: ${d.username}\nrole: ${d.role}\ndeviceId: ${d.deviceId}\nIP: ${d.ip}\nlastSeen: ${new Date(d.lastSeenAt||0).toLocaleString()}`); };
    actions.append(btnKick, btnBanDev, btnBanIp, btnInfo);
    card.append(head, info, actions);
    wrap.appendChild(card);
  });

  // قائمة الحظر + زر فك الحظر
  const bans = await get('/api/admin/bans', true);
  const bwrap = $('#banList'); bwrap.innerHTML = '';
  if (!bans.length){ bwrap.textContent = 'لا يوجد محظورون.'; return; }
  bans.forEach(b=>{
    const row = el('div','card');
    const top = el('div','row');
    top.innerHTML = `<span class="pill">النوع: ${b.type}</span><span class="pill">المفتاح: ${b.key}</span>`;
    const info = el('div','muted'); info.textContent = `السبب: ${b.reason || '-'} · منذ: ${new Date(b.createdAt).toLocaleString()} ${b.expiresAt ? '· ينتهي: '+new Date(b.expiresAt).toLocaleString() : ''}`;
    const actions = el('div','row');
    const btnUnban = el('button','iconbtn'); btnUnban.type='button'; btnUnban.textContent='فك الحظر';
    btnUnban.onclick = ()=> post('/api/admin/unban', { key: b.key }, true).then(()=>{ alert('تم فك الحظر عن: '+b.key); loadAdmin(); });
    actions.append(btnUnban);
    row.append(top, info, actions);
    bwrap.appendChild(row);
  });
}

// DM Icon
$('#iconDM').onclick = ()=>{ const p=$('#dmPanel'); p.style.display = (p.style.display==='flex'?'none':'flex'); };

// Send message
$('#send').onclick = ()=>{ const t=$('#msg').value.trim(); if(!t) return; state.socket.emit('chat:msg', { text: t }); $('#msg').value=''; };

// Login
async function doLogin(kind){
  try{
    let data;
    if (kind==='admin'){
      data = await post('/api/login-pass', { username: $('#au').value.trim(), password: $('#ap').value, deviceId: deviceId() }, false);
    } else {
      data = await post('/api/login', { username: $('#u').value.trim(), deviceId: deviceId() }, false);
    }
    state.token = data.token;
    setLoggedIn({ username:data.username, role:data.role, color:data.color });
    await loadSocketClient();
    connectSocket();
  }catch(e){ alert(e.message || 'login failed'); }
}
$('#loginQuick').onclick = ()=> doLogin('user');
$('#loginAdmin').onclick = ()=> doLogin('admin');

function loadSocketClient(){
  return new Promise((resolve,reject)=>{
    const existing = document.querySelector('script[data-sock="1"]');
    if (existing){ resolve(); return; }
    const s = document.createElement('script');
    s.dataset.sock = '1';
    s.src = state.base + '/socket.io/socket.io.js';
    s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}
function connectSocket(){
  state.socket = io(state.base, { auth: { token: state.token } });
  state.socket.on('history', arr => { $('#messages').innerHTML=''; arr.forEach(pushMessage); });
  state.socket.on('chat:new', pushMessage);
  state.socket.on('presence', renderPresence);
  state.socket.on('admin:clear', ()=> $('#messages').innerHTML='');
  state.socket.on('dm:new', rec => {
    if (state.dmWith && (rec.fromId===state.dmWith.userId || rec.toId===state.dmWith.userId)){
      const line = el('div'); line.textContent = (rec.fromId===state.dmWith.userId? state.dmWith.username : 'أنا') + ': ' + rec.text;
      $('#dmMsgs').appendChild(line);
      $('#dmMsgs').scrollTop = $('#dmMsgs').scrollHeight;
    }
  });
  state.socket.on('banned', info => { alert((info && info.reason) || 'banned'); state.socket.disconnect(); });
}
</script>
</body>
</html>
