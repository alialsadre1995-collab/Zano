<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>#Ø§Ù„Ø¹Ø±Ø¨ â€” ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e7eaf0; --muted:#a6adbb;
    --line:#22252b; --accent:#30c0ff; --accent2:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100dvh}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .app{max-width:800px;margin:0 auto;height:100dvh;display:flex;flex-direction:column}

  /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
  .hdr{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:#0d0f14;position:sticky;top:0;z-index:5}
  .badge{background:#0f1720;border:1px solid var(--line);color:#cbd5e1;border-radius:6px;padding:3px 7px;font-weight:700}
  .chan{font-weight:800}
  .icons{margin-inline-start:auto;display:flex;gap:10px}
  .ic{width:32px;height:32px;border-radius:8px;border:1px solid var(--line);display:grid;place-items:center;cursor:pointer;background:#0f1218}
  .ic:active{transform:scale(.98)}

  /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
  #messages{
    flex:1;overflow:auto;padding:12px 14px;background:#0b0c0f;
    scroll-behavior:auto;-webkit-overflow-scrolling:touch;
  }
  .sys{color:#9fb4c7;font-style:italic;margin:6px 0;white-space:pre-wrap}
  .row{margin:10px 0}
  .head{display:flex;gap:6px;align-items:baseline;direction:ltr;text-align:left} /* Ø§Ù„Ø§Ø³Ù… ÙŠØ³Ø§Ø± */
  .nick{color:#5fc3ff;font-weight:700;cursor:pointer}
  .time{color:var(--muted);font-size:12px}
  .txt{white-space:pre-wrap;word-break:break-word}

  /* Ø§Ù„Ù…Ø¤Ù„Ù */
  .cmp{position:fixed;left:0;right:0;bottom:0;background:#0f1218;border-top:1px solid var(--line);padding:8px;z-index:10}
  .cmp .bar{max-width:800px;margin:0 auto;display:flex;gap:8px;align-items:center}
  #msg{flex:1;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#050608;color:#fff;font-size:17px}
  .send{width:48px;height:48px;border-radius:12px;border:1px solid var(--line);background:var(--accent);color:#001018;font-weight:800;cursor:pointer}
  .send:active{transform:translateY(1px)}

  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† */
  .drawer{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:30}
  .panel{background:#0f1218;border-bottom:1px solid var(--line);position:absolute;left:0;right:0;top:0;max-width:800px;margin:0 auto}
  .ph{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .list{max-height:55vh;overflow:auto}
  .user{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--line);cursor:pointer}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--accent2)}
  .uname{direction:ltr}

  .b{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#0b0e14;color:#d8e0ea;cursor:pointer}
  .b.danger{background:#270b0b;color:#f6caca;border-color:#3a0d0d}
  .b.warn{background:#221a05;color:#fcd174;border-color:#3a2b07}

  /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø§Øµ */
  .dm{position:fixed;right:10px;bottom:76px;width:340px;max-width:92vw;display:none;flex-direction:column;background:#0f1218;border:1px solid var(--line);border-radius:12px;z-index:40;box-shadow:0 12px 32px rgba(0,0,0,.55)}
  .dmH{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
  .dmT{font-weight:700}
  .dmB{max-height:44vh;overflow:auto;padding:10px}
  .dmC{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
  .dmC input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#050608;color:#fff}
  .dmC button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:var(--accent);color:#001018}
  .dmMax{inset:0!important;position:fixed!important;width:auto!important;height:auto!important;max-width:none!important;border-radius:0!important}

  /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  .loginOv{position:fixed;inset:0;background:#0b0c0fe6;display:flex;align-items:center;justify-content:center;z-index:99}
  .loginCard{width:min(92vw,520px);background:#0f1218;border:1px solid var(--line);border-radius:14px;padding:14px}
  .loginCard h3{margin:0 0 10px}
  .loginRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .loginCard input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#050608;color:#fff}
  .loginCard .btn{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:var(--accent);color:#001018;cursor:pointer}
  .loginCard .ghost{background:transparent;color:#d8e0ea}

  /* Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¨Ø³ÙŠØ·Ø© */
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:50}
  .sheetBox{max-width:780px;margin:8vh auto;background:#0f1218;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sheetHd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .sheetBd{max-height:60vh;overflow:auto}
  .rowAdmin{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  .tag{border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:#9ed0ff}

  @supports (-webkit-touch-callout:none){
    input,textarea,select,button{font-size:16px!important}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Ø±Ø£Ø³ -->
  <div class="hdr">
    <span class="badge" id="badgeCnt">0</span>
    <span class="chan">#Ø§Ù„Ø¹Ø±Ø¨</span>
    <div class="icons">
      <div class="ic" id="btnInfo">â„¹ï¸</div>
      <div class="ic" id="btnPeople">ğŸ‘¥</div>
      <div class="ic" id="btnAdmin">ğŸ›¡ï¸</div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="loginOv" id="loginOv">
    <div class="loginCard">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="loginRow">
        <input id="lu" placeholder="Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (ÙŠØ­ÙˆÙÙ‘Ù„ Ø¥Ù„Ù‰ Guest Ø¥Ù† ØªÙØ±Ùƒ ÙØ§Ø±Øº)">
        <button class="btn" id="btnUserLogin">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <hr style="border-color:var(--line);opacity:.3">
      <div class="loginRow">
        <input id="au" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù">
        <input id="ap" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button class="btn" id="btnAdminLogin">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</button>
      </div>
      <div class="loginRow">
        <button class="btn ghost" id="btnSkip">Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ¶ÙŠÙ</button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <div id="messages"></div>

  <!-- Ø§Ù„Ù…Ø¤Ù„Ù -->
  <div class="cmp">
    <div class="bar">
      <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©â€¦">
      <button class="send" id="send">â¤</button>
    </div>
  </div>
</div>

<!-- Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† -->
<div class="drawer" id="drawer">
  <div class="panel">
    <div class="ph">
      <strong id="pcount">0 Ù…ØªÙˆØ§Ø¬Ø¯</strong>
      <button class="b" id="closeDrawer">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>
    <div class="list" id="plist"></div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© DM -->
<div class="dm" id="dm">
  <div class="dmH">
    <div class="dmT" id="dmT">Ø®Ø§Øµ</div>
    <div>
      <button class="b" id="dmMin">â€”</button>
      <button class="b" id="dmFull">â¤¢</button>
      <button class="b danger" id="dmX">âœ•</button>
    </div>
  </div>
  <div class="dmB" id="dmB"></div>
  <div class="dmC">
    <input id="dmI" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©â€¦">
    <button id="dmS">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø± + ÙÙƒ Ø­Ø¸Ø± -->
<div class="sheet" id="sheet">
  <div class="sheetBox">
    <div class="sheetHd">
      <strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong>
      <button class="b" id="sheetX">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="sheetBd" id="sheetBd">
      <div class="rowAdmin"><em>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±â€¦</em></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
const state={ base:location.origin, token:null, me:null, socket:null, role:'user', color:'#5fc3ff', dmWith:null };
const $=s=>document.querySelector(s); const el=(t,c)=>{const x=document.createElement(t); if(c)x.className=c; return x;};
const deviceId=()=>{ let id=localStorage.getItem('deviceId'); if(!id){ id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2); localStorage.setItem('deviceId',id);} return id; };
async function post(p,body,auth=true){const h={'Content-Type':'application/json'};if(auth&&state.token)h.Authorization='Bearer '+state.token;const r=await fetch(state.base+p,{method:'POST',headers:h,body:JSON.stringify(body||{})});const d=await r.json();if(d.error)throw new Error(d.error);return d;}
async function get(p,auth=true){const h={};if(auth&&state.token)h.Authorization='Bearer '+state.token;const r=await fetch(state.base+p,{headers:h});const d=await r.json();if(d.error)throw new Error(d.error);return d;}

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
async function doLogin(kind){
  try{
    let data;
    if(kind==='admin'){
      const au = ($('#au').value||'').trim();
      const ap = $('#ap').value||'';
      data = await post('/api/login-pass', { username:au, password:ap, deviceId:deviceId() }, false);
    }else{
      let name = ($('#lu').value||'').trim();
      if(!/^[A-Za-z0-9_.-]{3,20}$/.test(name||'')) name = '';
      data = await post('/api/login', { username:name, deviceId:deviceId() }, false);
    }
    state.token=data.token;
    state.me={userId:data.userId, username:data.username};
    state.role=data.role;

    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ + ØªØ±Ø­ÙŠØ¨ Ø·ÙˆÙŠÙ„ (Ø£Ø±Ø¨Ø¹ Ø£Ø³Ø·Ø±)
    $('#loginOv').style.display='none';
    pushSys(
`Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨ â€” Ù†ØªÙ…Ù†Ù‘Ù‰ Ù„Ùƒ ÙˆÙ‚ØªÙ‹Ø§ Ù…Ù…ØªØ¹Ù‹Ø§ ğŸ¤
â¤ï¸ğŸ˜ğŸ¥³
â˜ºï¸ğŸ˜
ğŸ¥³ğŸ¥³
ğŸ˜œ`
    );

    connectSocket();
    setTimeout(()=>{ layout(); stickToBottom(true); },0);
  }catch(e){ alert(e.message||'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
}
$('#btnUserLogin').onclick = ()=> doLogin('user');
$('#btnAdminLogin').onclick = ()=> doLogin('admin');
$('#btnSkip').onclick      = ()=> doLogin('user');

/* ===== Socket ===== */
function connectSocket(){
  state.socket = io(state.base, { auth:{ token: state.token } });

  state.socket.on('history', arr=>{ $('#messages').innerHTML=''; arr.forEach(pushLine); forceStick(); });
  state.socket.on('chat:new', pushLine);
  state.socket.on('presence', list=>{ renderPresence(list); cacheUsers(list); });
  state.socket.on('system', m=> pushSys(m.text||''));
  state.socket.on('admin:clear', ()=> $('#messages').innerHTML='');
  state.socket.on('banned', info=>{ alert((info&&info.reason)||'ØªÙ… Ø§Ù„Ø­Ø¸Ø±'); state.socket.disconnect(); });

  // DM
  state.socket.on('dm:new', rec=>{
    if(state.dmWith && (rec.fromId===state.dmWith.userId || rec.toId===state.dmWith.userId)){
      const line=document.createElement('div');
      line.textContent=(rec.fromId===state.dmWith.userId? state.dmWith.username : 'Ø£Ù†Ø§')+': '+rec.text;
      $('#dmB').appendChild(line);
      $('#dmB').scrollTop = $('#dmB').scrollHeight;
    }
  });
}

/* ===== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ + ØªØ«Ø¨ÙŠØª Ù‚ÙˆÙŠ Ù„Ù„Ø£Ø³ÙÙ„ ===== */
const M = ()=> document.getElementById('messages');
function isNearBottom(el,tol=6){ return (el.scrollHeight - el.scrollTop - el.clientHeight) <= tol; }
let _stick = true;

// ØªÙ…Ø±ÙŠØ± Ø¨Ø§Ù„Ù‚ÙˆØ© 5 Ø¥Ø·Ø§Ø±Ø§Øª Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ£Ø®Ø± iOS
function forceStick(){
  const el=M(); if(!el) return;
  let tries=0;
  function step(){ el.scrollTop = el.scrollHeight; if(++tries<5) requestAnimationFrame(step); }
  requestAnimationFrame(step);
}
function stickToBottom(force=false){ if(force || _stick) forceStick(); }

function pushSys(t){
  const s=el('div','sys'); s.textContent='â†’ '+t;
  M().appendChild(s); stickToBottom(true);
}

// Ø®Ø±ÙŠØ·Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
const userIndex=new Map(); // username => userObj
function cacheUsers(list){ list.forEach(u=> userIndex.set(u.username,u)); }

function pushLine(m){
  const row=el('div','row');
  const head=el('div','head');
  const nameEl=document.createElement('span');
  nameEl.className='nick';
  nameEl.style.color=m.color||'#5fc3ff';
  nameEl.textContent=m.from;
  nameEl.dataset.username=m.from;
  if(m.userId) nameEl.dataset.userId = m.userId;
  nameEl.addEventListener('click', ()=> openUserMenuByName(nameEl.dataset.username));
  const timeEl=document.createElement('span'); timeEl.className='time'; timeEl.textContent=new Date(m.ts).toLocaleTimeString();
  head.append(nameEl,timeEl);

  const txt=el('div','txt'); txt.textContent=m.text;
  row.append(head,txt); M().appendChild(row); stickToBottom(true);
}
M().addEventListener('scroll', ()=>{ _stick = isNearBottom(M()); }, { passive:true });

/* ===== Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† ===== */
function renderPresence(list){
  $('#badgeCnt').textContent = list.length;
  $('#pcount').textContent   = `${list.length} Ù…ØªÙˆØ§Ø¬Ø¯`;
  const box=$('#plist'); box.innerHTML='';
  list.forEach(u=>{
    const li=el('div','user');
    const dot=el('span','dot');
    const name=el('span','uname'); name.textContent=u.username; name.style.color=u.color||'#9ed0ff'; name.style.direction='ltr';
    li.append(dot,name);
    li.onclick=()=> userMenu(u);
    box.appendChild(li);
  });
}
$('#btnPeople').onclick = ()=> $('#drawer').style.display='block';
$('#closeDrawer').onclick = ()=> $('#drawer').style.display='none';
$('#drawer').onclick = (e)=>{ if(e.target.id==='drawer') $('#drawer').style.display='none'; };

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ===== */
function openUserMenuByName(username){
  const u = userIndex.get(username) || { username };
  userMenu(u);
}
function userMenu(u){
  const m=document.createElement('div');
  m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:40';
  const b=document.createElement('div');
  b.style.cssText='background:#0f1218;border:1px solid var(--line);padding:12px;border-radius:10px;min-width:280px';
  b.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <strong style="direction:ltr;color:${u.color||'#9ed0ff'}">${u.username}</strong>
      <button class="b" id="x">âœ•</button>
    </div>`;
  const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='8px'; row.style.marginTop='10px';

  // Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
  const reply=btn('Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©', ()=>{
    const inp=$('#msg'); inp.value = (inp.value?inp.value+'\n':'') + `@${u.username}: `;
    inp.focus(); m.remove();
  });
  const openDM = btn('ÙØªØ­ Ø®Ø§Øµ', ()=>{ m.remove(); showDM(u.userId||u.username, u.username); });
  row.append(reply, openDM);

  if(state.role==='admin'||state.role==='mod'){
    const info=btn('ÙƒØ´Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', async ()=>{
      const key = u.userId ? ('userId='+encodeURIComponent(u.userId)) : ('username='+encodeURIComponent(u.username));
      const d=await get('/api/admin/user-info?'+key,true);
      alert(`userId: ${d.userId}\nusername:${d.username}\nrole:${d.role}\ndevice:${d.deviceId}\nIP:${d.ip}`);
    });
    const kick=btn('Ø·Ø±Ø¯', ()=> post('/api/admin/kick',{deviceId:u.deviceId,reason:'admin'},true));
    const banDev=btn('Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²', ()=> post('/api/admin/ban',{targetType:'deviceId',targetValue:u.deviceId,reason:'admin'},true));
    const banIp=btn('Ø­Ø¸Ø± IP', ()=> post('/api/admin/ban',{targetType:'ip',targetValue:u.ip,reason:'admin'},true));
    row.append(info,kick,banDev,banIp);
  }

  b.appendChild(row); m.appendChild(b); document.body.appendChild(m);
  m.querySelector('#x').onclick=()=> m.remove();
  function btn(t,fn){ const x=document.createElement('button'); x.className='b'; x.textContent=t; x.onclick=fn; return x; }
}

/* ===== DM ===== */
function showDM(userId, username){
  state.dmWith={userId,username};
  $('#dmT').textContent='Ø®Ø§Øµ: '+username;
  $('#dmB').innerHTML='';
  $('#dm').style.display='flex';
  $('#dmI').focus();
}
$('#dmX').onclick=()=> $('#dm').style.display='none';
$('#dmMin').onclick=()=> $('#dm').style.display='none';
let dmFull=false; $('#dmFull').onclick=()=>{ dmFull=!dmFull; $('#dm').classList.toggle('dmMax', dmFull); };
$('#dmS').onclick=sendDM;
$('#dmI').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendDM(); }});
function sendDM(){
  const t=$('#dmI').value.trim(); if(!t||!state.dmWith) return;
  state.socket.emit('dm:send',{toId:state.dmWith.userId,text:t});
  $('#dmI').value=''; $('#dmI').focus();
}

/* ===== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ===== */
$('#send').onclick = send;
$('#msg').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
function send(){
  const t=$('#msg').value.trim(); if(!t) return;
  state.socket.emit('chat:msg',{text:t});
  $('#msg').value=''; $('#msg').focus();
  stickToBottom(true);
}

/* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¸Ø± + ÙÙƒ Ø§Ù„Ø­Ø¸Ø± ===== */
$('#btnAdmin').onclick = async ()=>{
  if(state.role!=='admin'&&state.role!=='mod'){ alert('Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
  $('#sheet').style.display='block';
  const bd=$('#sheetBd'); bd.innerHTML='<div class="rowAdmin"><em>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±â€¦</em></div>';
  try{
    const bans = await get('/api/admin/bans', true); // [{targetType:'deviceId'|'ip', targetValue:'...', username?, ts?}, ...]
    bd.innerHTML='';
    if(!bans.length){ bd.innerHTML='<div class="rowAdmin"><em>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø­Ø¸Ø±.</em></div>'; return; }
    bans.forEach(b=>{
      const r=el('div','rowAdmin');
      r.innerHTML = `
        <span class="tag">${b.targetType==='ip'?'IP':'Ø¬Ù‡Ø§Ø²'}</span>
        <strong style="direction:ltr">${b.targetValue||''}</strong>
        ${b.username?`<span class="tag" style="color:#ddd"> ${b.username} </span>`:''}
        <span style="color:var(--muted);font-size:12px">${b.ts?new Date(b.ts).toLocaleString():''}</span>
      `;
      const un=el('button','b warn'); un.textContent='ÙÙƒ Ø­Ø¸Ø±';
      un.onclick=async()=>{
        try{
          await post('/api/admin/unban',{targetType:b.targetType,targetValue:b.targetValue},true);
          r.remove();
        }catch(e){ alert(e.message||'ÙØ´Ù„ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±'); }
      };
      r.appendChild(un);
      bd.appendChild(r);
    });
  }catch(e){
    bd.innerHTML='<div class="rowAdmin"><em>ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</em></div>';
  }
};
$('#sheetX').onclick=()=> $('#sheet').style.display='none';

/* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø£Ø³ ===== */
$('#btnInfo').onclick = ()=> alert('#Ø§Ù„Ø¹Ø±Ø¨ â€” ØºØ±ÙØ© Ø¯Ø±Ø¯Ø´Ø© Ø¯Ø§ÙƒÙ†Ø© Ø¨Ø³ÙŠØ·Ø©');

/* ===== ØªØ®Ø·ÙŠØ· ÙˆÙƒÙŠØ¨ÙˆØ±Ø¯ iOS ===== */
function layout(){
  const vv = window.visualViewport;
  const vvh = vv ? vv.height : window.innerHeight;
  const headerH = document.querySelector('.hdr').getBoundingClientRect().height;
  const cmpH    = document.querySelector('.cmp').getBoundingClientRect().height;
  const h = Math.max(140, Math.round(vvh - headerH - cmpH));
  M().style.height = h+'px';
}
let kbLoop=null;
function startKBLoop(){ if(kbLoop) return; const step=()=>{ layout(); stickToBottom(); kbLoop = requestAnimationFrame(step); }; kbLoop=requestAnimationFrame(step); }
function stopKBLoop(){ if(kbLoop){ cancelAnimationFrame(kbLoop); kbLoop=null; } }

window.visualViewport && visualViewport.addEventListener('resize', ()=>{ layout(); stickToBottom(); });
window.addEventListener('resize', ()=>{ layout(); stickToBottom(); });
window.addEventListener('orientationchange', ()=> setTimeout(()=>{ layout(); stickToBottom(true); },120));
document.addEventListener('focusin', e=>{ if(e.target.id==='msg'){ startKBLoop(); }});
document.addEventListener('focusout', e=>{ if(e.target.id==='msg'){ stopKBLoop(); setTimeout(()=>{ layout(); stickToBottom(); },0); }});
document.addEventListener('DOMContentLoaded', ()=>{ layout(); stickToBottom(true); });
</script>
</body>
</html>
