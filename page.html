<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨</title>
<style>
  :root{
    --bg:#0a0b0e;--surface:#0f1218;--line:#222630;--fg:#e7eaf0;--muted:#a7afbd;--accent:#30c0ff;--fs:16px
  }
  [data-theme="light"]{
    --bg:#f6f7fb;--surface:#ffffff;--line:#e6e8ef;--fg:#0e1320;--muted:#5b6474;--accent:#0077ff;
  }
  *{box-sizing:border-box} html,body{height:100dvh} body{margin:0;background:var(--bg);color:var(--fg);font:var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:920px;margin:0 auto;height:100dvh;display:flex;flex-direction:column}
  .top{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border-bottom:1px solid var(--line)}
  .title{font-weight:800}.pill{background:#0d131c;border:1px solid var(--line);padding:2px 7px;border-radius:8px;color:#cdd5e1}
  [data-theme="light"] .pill{background:#eef3ff;color:#234}
  .sp{margin-inline-start:auto;display:flex;gap:8px}.btn{display:grid;place-items:center;width:34px;height:34px;border:1px solid var(--line);border-radius:9px;background:#0c1017;cursor:pointer}
  [data-theme="light"] .btn{background:#f2f6ff}

  .pin{background:#0b1118;border-bottom:1px solid var(--line);padding:8px 12px;color:#9fb4c7;white-space:pre-wrap}
  [data-theme="light"] .pin{background:#eef3ff;color:#223a57}

  .log{flex:1;overflow:auto;background:#0b0c10;padding:8px 10px}
  [data-theme="light"] .log{background:#f8faff}
  .row{padding:8px 10px;margin:4px 0;border-radius:8px}
  .head{direction:ltr;text-align:left;font-weight:700;display:flex;gap:6px;align-items:baseline}
  .nick{color:#59caff;cursor:pointer}.time{color:var(--muted);font-size:12px}
  .txt{white-space:pre-wrap;word-break:break-word}
  .sys{color:#9fb4c7;font-style:italic;white-space:pre-wrap;padding:6px 8px;margin:8px 0;border-left:3px solid #2a3a4a;background:#0b1118;border-radius:6px}
  [data-theme="light"] .sys{background:#eef3ff;color:#3a4d64;border-left-color:#9cb3d6}

  .dock{background:var(--surface);border-top:1px solid var(--line);padding:8px;position:sticky;bottom:0}
  .row1{display:flex;gap:8px;align-items:center}
  .send{width:58px;height:46px;border-radius:12px;background:var(--accent);color:#001018;border:1px solid var(--line);font-weight:800;cursor:pointer}
  #msg{flex:1;height:46px;border-radius:12px;border:1px solid var(--line);background:#05070b;color:#fff;padding:0 14px;font-size:17px}
  [data-theme="light"] #msg{background:#fff;color:#000}

  .drawer{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:30}
  .panel{background:var(--surface);border-bottom:1px solid var(--line);position:absolute;left:0;right:0;top:0;max-width:920px;margin:0 auto}
  .ph{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
  .list{max-height:55vh;overflow:auto}
  .user{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .dot{width:8px;height:8px;border-radius:50%;background:#22c55e}.uname{direction:ltr}
  .av{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}

  .dm{position:fixed;right:10px;bottom:92px;width:360px;max-width:92vw;display:none;flex-direction:column;background:var(--surface);border:1px solid var(--line);border-radius:12px;z-index:40}
  .dmH{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
  .dmB{max-height:46vh;overflow:auto;padding:10px}
  .dmC{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
  .dmC input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#050608;color:#fff}
  [data-theme="light"] .dmC input{background:#fff;color:#000}
  .dmC button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:var(--accent);color:#001018}
  .dmMax{inset:0!important;width:auto!important;height:auto!important;max-width:none!important;border-radius:0!important}

  .login{position:fixed;inset:0;background:#0b0c0fe6;display:flex;align-items:center;justify-content:center;z-index:99}
  .card{width:min(92vw,520px);background:var(--surface);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 10px}
  .rowi{display:grid;grid-template-columns:1fr;gap:8px;align-items:center;margin:10px 0}
  .card input{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#050608;color:#fff}
  [data-theme="light"] .card input{background:#fff;color:#000}
  .card .btn{padding:12px;border:1px solid var(--line);border-radius:10px;background:var(--accent);color:#001018;cursor:pointer}
  .ghost{background:transparent;color:#d8e0ea;border-color:var(--line)}
</style>
</head>
<body>
<div class="wrap" id="root">
  <div class="top">
    <span class="pill" id="online">0</span>
    <span class="title">#Ø§Ù„Ø¹Ø±Ø¨</span>
    <div class="sp">
      <div class="btn" id="iTheme">ğŸŒ“</div>
      <div class="btn" id="iTools">ğŸ§°</div>
      <div class="btn" id="iAdmin">ğŸ›¡ï¸</div>
      <div class="btn" id="iInfo">â„¹ï¸</div>
      <div class="btn" id="iPeople">ğŸ‘¥</div>
    </div>
  </div>

  <div id="pin" class="pin" style="display:none"></div>

  <!-- Login Ø¨Ø­Ù‚Ù„ÙŠÙ† -->
  <div class="login" id="login">
    <div class="card">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="rowi"><input id="user" placeholder="Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Guest Ø¥Ø°Ø§ ØªÙØ±Ùƒ ÙØ§Ø±Øº)"></div>
      <div class="rowi"><input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (ÙØ§Ø±ØºØ© = Ù…Ø³ØªØ®Ø¯Ù…)"></div>
      <div class="rowi"><button class="btn" id="btnGo">Ø¯Ø®ÙˆÙ„</button></div>
      <div class="rowi" style="color:#a7afbd">â€¢ Ù†ÙØ³ Ø§Ù„Ø®Ø§Ù†Ø© ØªØ¹Ù…Ù„ Ù„Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ø£Ø¯Ù…Ù†/Ø§Ù„Ù…Ø´Ø±Ù. (Ù„Ùˆ ÙØ¹Ù‘Ù„Øª 2FA Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§ÙƒØªØ¨: <code>pass code</code>)</div>
      <div class="rowi" style="color:#a7afbd">â€¢ Ø­Ø¯Ù‘Ø« Ù…Ù„ÙÙ‘Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£Ø¯ÙˆØ§Øª â†’ "Ù…Ù„ÙÙŠ".</div>
    </div>
  </div>

  <!-- Messages -->
  <div id="messages" class="log"></div>

  <!-- Composer -->
  <div class="dock"><div class="row1"><button class="send" id="send">â¤</button><input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©â€¦ (Ø¬Ø±Ù‘Ø¨ /help)"></div></div>
</div>

<!-- People -->
<div class="drawer" id="drawer"><div class="panel"><div class="ph"><strong id="pcount">0 Ù…ØªÙˆØ§Ø¬Ø¯</strong><button class="b" id="closeDrawer">Ø¥ØºÙ„Ø§Ù‚ âœ•</button></div><div class="list" id="plist"></div></div></div>

<!-- DM -->
<div class="dm" id="dm"><div class="dmH"><strong id="dmT">Ø®Ø§Øµ</strong><div><button class="b" id="dmMin">â€”</button><button class="b" id="dmFull">â¤¢</button><button class="b" id="dmX">âœ•</button></div></div><div class="dmB" id="dmB"></div><div class="dmC"><input id="dmI" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©â€¦"><button id="dmS">Ø¥Ø±Ø³Ø§Ù„</button></div></div>

<!-- Admin sheet -->
<div class="sheet" id="sheet"><div class="sheetBox"><div class="sheetHd"><strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong><button class="b" id="sheetX">Ø¥ØºÙ„Ø§Ù‚</button></div><div class="sheetBd" id="sheetBd"><div class="rowAdmin"><em>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</em></div></div></div></div>

<!-- Tools -->
<div class="tools" id="tools" style="position:fixed;top:56px;right:calc(50% - 420px);background:var(--surface);border:1px solid var(--line);border-radius:10px;display:none;z-index:35;padding:10px;min-width:260px">
  <div class="ttl" style="font-weight:700;margin-bottom:8px">Ø£Ø¯ÙˆØ§Øª</div>
  <div class="rowt" style="display:flex;gap:8px;align-items:center;margin:6px 0">
    <button class="mini" id="tOpenDM" style="padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#0b0e14;color:#d8e0ea;cursor:pointer">ÙØªØ­ Ø§Ù„Ø®Ø§Øµ</button>
    <span style="color:var(--muted)">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ø³Ù…Ù‡.</span>
  </div>
  <div class="rowt" style="display:flex;gap:8px;align-items:center;margin:6px 0">
    <span style="min-width:88px">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</span>
    <button class="mini" id="fsMinus">âˆ’</button>
    <button class="mini" id="fsPlus">+</button>
  </div>
  <div class="rowt" style="display:flex;gap:8px;align-items:center;margin:6px 0">
    <button class="mini" id="myProfile">Ù…Ù„ÙÙŠ</button>
    <button class="mini" id="friendsBtn">Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const state={ base:location.origin, token:null, me:null, socket:null, role:'user', dmWith:null, theme:localStorage.getItem('chat.theme')||'dark', friends:new Set(JSON.parse(localStorage.getItem('chat.friends')||'[]')) };
const $=s=>document.querySelector(s), el=(t,c)=>{const x=document.createElement(t); if(c)x.className=c; return x;};
const deviceId=()=>{ let id=localStorage.getItem('deviceId'); if(!id){ id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2); localStorage.setItem('deviceId',id);} return id; };
async function post(p,b,a=true){const h={'Content-Type':'application/json'}; if(a&&state.token)h.Authorization='Bearer '+state.token; const r=await fetch(state.base+p,{method:'POST',headers:h,body:JSON.stringify(b||{})}); const d=await r.json(); if(d.error) throw new Error(d.error); return d;}
async function get(p,a=true){const h={}; if(a&&state.token)h.Authorization='Bearer '+state.token; const r=await fetch(state.base+p,{headers:h}); const d=await r.json(); if(d.error) throw new Error(d.error); return d;}

/* Theme */
function applyTheme(){ document.getElementById('root').setAttribute('data-theme', state.theme==='light'?'light':'dark'); }
applyTheme();
document.getElementById('iTheme').onclick=()=>{ state.theme = (state.theme==='light'?'dark':'light'); localStorage.setItem('chat.theme',state.theme); applyTheme(); };

/* Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
function applyFs(){ const fs=+localStorage.getItem('chat.fs')||16; document.documentElement.style.setProperty('--fs',fs+'px'); }
applyFs(); 
document.getElementById('fsPlus').onclick=()=>{ const v=Math.min(24,(+localStorage.getItem('chat.fs')||16)+1); localStorage.setItem('chat.fs',v); applyFs(); };
document.getElementById('fsMinus').onclick=()=>{ const v=Math.max(12,(+localStorage.getItem('chat.fs')||16)-1); localStorage.setItem('chat.fs',v); applyFs(); };

/* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØµÙˆØªÙŠØ© */
const ding = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAACAAACAgAA'); // ØµÙÙŠØ± Ù‚ØµÙŠØ± (ØµØ§Ù…Øª ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ØŒ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
function ping(){ try{ ding.currentTime=0; ding.play(); }catch{} }

/* Login */
async function doLogin(){
  try{
    const uname=($('#user').value||'').trim();
    const pass =($('#pass').value||'').trim();
    const data=await post('/api/login-smart',{username:uname, password:pass, deviceId:deviceId()},false);
    state.token=data.token; state.me={userId:data.userId,username:data.username}; state.role=data.role;
    $('#login').style.display='none'; pushWelcome(); connectSocket(); setTimeout(()=>{ layout(); stickToBottom(true); },0);
  }catch(e){ alert(e.message||'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
}
$('#btnGo').onclick=doLogin;
$('#pass').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });
$('#user').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });

/* Socket */
function connectSocket(){
  state.socket=io(state.base,{auth:{token:state.token}});
  state.socket.on('history',arr=>{ $('#messages').innerHTML=''; pushWelcome(); arr.forEach(pushLine); forceStick(); });
  state.socket.on('chat:new',m=>{ pushLine(m); if(isMention(m.text, state.me.username)) highlightTitle(); });
  state.socket.on('presence',list=>{ renderPresence(list); cacheUsers(list); checkFriendsOnline(list); });
  state.socket.on('system',m=> pushSys(m.text||''));  
  state.socket.on('admin:clear',()=> $('#messages').innerHTML='');
  state.socket.on('banned',info=>{ alert((info&&info.reason)||'ØªÙ… Ø§Ù„Ø­Ø¸Ø±'); state.socket.disconnect(); });
  state.socket.on('dm:new', rec=>{
    if(state.dmWith && (rec.fromId===state.dmWith.userId || rec.toId===state.dmWith.userId)){
      const line=document.createElement('div'); line.textContent=(rec.fromId===state.dmWith.userId? state.dmWith.username : 'Ø£Ù†Ø§')+': '+rec.text;
      $('#dmB').appendChild(line); $('#dmB').scrollTop=$('#dmB').scrollHeight;
    }
    ping(); highlightTitle();
  });
  state.socket.on('stats', s=>{ state.stats=s; });
  state.socket.on('pin:update', data=>{ const p=$('#pin'); if(data){ p.style.display='block'; p.textContent='ğŸ“Œ '+data.text; } else { p.style.display='none'; p.textContent=''; } });
}

/* Ø¹Ù†ÙˆØ§Ù† ÙŠÙˆÙ…Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
let titleBase=document.title, titleTimer=null;
function highlightTitle(){ if(!document.hidden) return; let i=0; if(titleTimer) clearInterval(titleTimer);
  titleTimer=setInterval(()=>{ document.title = (++i%2)? 'ğŸ”” Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : titleBase; if(i>8){ clearInterval(titleTimer); document.title=titleBase; } }, 600);
}

/* Mentions */
function isMention(txt, name){ if(!txt||!name) return false; const re=new RegExp('(^|\\s)@'+name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'(\\b|\\s)','i'); return re.test(txt); }

/* Ø±Ø³Ø§Ø¦Ù„ + ØªØ«Ø¨ÙŠØª */
const M=()=>document.getElementById('messages');
function isNearBottom(el,tol=6){return(el.scrollHeight-el.scrollTop-el.clientHeight)<=tol}
let _stick=true;
function forceStick(){const el=M(); if(!el) return; let i=0; function step(){el.scrollTop=el.scrollHeight; if(++i<5) requestAnimationFrame(step);} requestAnimationFrame(step);}
function stickToBottom(force=false){ if(force||_stick) forceStick(); }

function pushWelcome(){
  if(document.getElementById('welcomeLine')) return;
  const w=el('div','sys'); w.id='welcomeLine';
  w.textContent=`Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨ â€” Ù†ØªÙ…Ù†Ù‘Ù‰ Ù„Ùƒ ÙˆÙ‚ØªÙ‹Ø§ Ù…Ù…ØªØ¹Ù‹Ø§ ğŸ¤
â¤ï¸ğŸ˜ğŸ¥³
â˜ºï¸ğŸ˜
ğŸ¥³ğŸ¥³
ğŸ˜œ`;
  M().appendChild(w);
}
function pushSys(t){ const s=el('div','sys'); s.textContent='â†’ '+t; M().appendChild(s); stickToBottom(true); }

const userIndex=new Map();
function cacheUsers(list){ userIndex.clear(); list.forEach(u=> userIndex.set(u.username,u)); }

function pushLine(m){
  const row=el('div','row');
  const head=el('div','head');
  const name=document.createElement('span'); name.className='nick'; name.style.color=m.color||'#59caff'; name.textContent=m.from; name.dataset.username=m.from; if(m.userId) name.dataset.userId=m.userId;
  name.onclick=()=> openUserMenuByName(name.dataset.username);
  const time=document.createElement('span'); time.className='time'; time.textContent=new Date(m.ts).toLocaleTimeString();
  head.append(name,time);
  const txt=el('div','txt'); txt.textContent=m.text;
  row.append(head,txt); M().appendChild(row); stickToBottom(true);
}
M().addEventListener('scroll',()=>{ _stick=isNearBottom(M()); },{passive:true});

/* Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† + Ø£ØµØ¯Ù‚Ø§Ø¡ */
function renderPresence(list){
  $('#online').textContent=list.length; $('#pcount').textContent=`${list.length} Ù…ØªÙˆØ§Ø¬Ø¯`;
  const box=$('#plist'); box.innerHTML='';
  list.forEach(u=>{
    const li=el('div','user');
    const dot=el('span','dot');
    const av=document.createElement('img'); av.className='av'; av.src=u.avatar||'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    const name=el('span','uname'); name.textContent=u.username; name.style.color=u.color||'#9ed0ff'; name.style.direction='ltr';
    const star=document.createElement('button'); star.textContent = state.friends.has(u.username)?'â­':'â˜†'; star.className='b'; star.style.marginInlineStart='auto';
    star.onclick=(e)=>{ e.stopPropagation(); toggleFriend(u.username); star.textContent= state.friends.has(u.username)?'â­':'â˜†'; };
    li.append(dot,av,name,star);
    li.onclick=()=>userMenu(u);
    box.appendChild(li);
  });
}
function toggleFriend(name){ if(state.friends.has(name)) state.friends.delete(name); else state.friends.add(name); localStorage.setItem('chat.friends', JSON.stringify([...state.friends])); }
function checkFriendsOnline(list){
  const names = new Set(list.map(x=>x.username));
  for(const f of state.friends){ if(names.has(f)){ toast(`${f} Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† âœ…`); ping(); } }
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function openUserMenuByName(username){ const u=userIndex.get(username)||{username}; userMenu(u); }
async function fetchInfo(u){
  const q = u.userId ? ('userId='+encodeURIComponent(u.userId)) : ('username='+encodeURIComponent(u.username));
  try{ return await get('/api/admin/user-info?'+q,true); }catch{ return null; }
}
function userMenu(u){
  const ov=document.createElement('div'); ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:45';
  const box=document.createElement('div'); box.style.cssText='background:#0f1218;border:1px solid var(--line);padding:12px;border-radius:10px;min-width:320px'
  box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
    <strong style="direction:ltr">${u.username}</strong><button class="b" id="x">âœ•</button></div>`;
  const row=document.createElement('div'); row.style='display:flex;flex-wrap:wrap;gap:8px;margin-top:10px';
  const reply=btn('Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©',()=>{ const inp=$('#msg'); inp.value=(inp.value?inp.value+'\n':'')+`@${u.username}: `; inp.focus(); ov.remove();});
  const openDM=btn('ÙØªØ­ Ø®Ø§Øµ',()=>{ ov.remove(); showDM(u.userId||u.username,u.username); });
  const star=btn(state.friends.has(u.username)?'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡':'Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚',()=>{ toggleFriend(u.username); alert(state.friends.has(u.username)?'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© â­':'ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©'); });
  row.append(reply,openDM,star);

  if(state.role==='owner'||state.role==='admin'||state.role==='mod'){
    const info=btn('ÙƒØ´Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',async()=>{ const d=await fetchInfo(u); if(!d) return alert('ØºÙŠØ± Ù…ØªØµÙ„'); alert(`userId:${d.userId}\nusername:${d.username}\nrole:${d.role}\nØ§Ù„Ø¬Ù‡Ø§Ø²:${d.deviceId}\nIP:${d.ip}`); });
    const kick=btn('Ø·Ø±Ø¯',async()=>{ const d=await fetchInfo(u); if(!d) return; await post('/api/admin/kick',{deviceId:d.deviceId},true); });
    const banDev=btn('Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²',async()=>{ const d=await fetchInfo(u); if(!d) return; await post('/api/admin/ban',{targetType:'deviceId',targetValue:d.deviceId},true); });
    const banIp=btn('Ø­Ø¸Ø± IP',async()=>{ const d=await fetchInfo(u); if(!d) return; await post('/api/admin/ban',{targetType:'ip',targetValue:d.ip},true); });
    row.append(info,kick,banDev,banIp);
  }
  box.appendChild(row); ov.appendChild(box); document.body.appendChild(ov);
  ov.querySelector('#x').onclick=()=>ov.remove();
  function btn(t,fn){ const b=document.createElement('button'); b.className='b'; b.textContent=t; b.onclick=fn; return b; }
}

/* DM */
function showDM(userId,username){ state.dmWith={userId,username}; $('#dmT').textContent='Ø®Ø§Øµ: '+username; $('#dmB').innerHTML=''; $('#dm').style.display='flex'; $('#dmI').focus(); }
$('#dmX').onclick=()=> $('#dm').style.display='none'; $('#dmMin').onclick=()=> $('#dm').style.display='none';
let dmFull=false; $('#dmFull').onclick=()=>{ dmFull=!dmFull; $('#dm').classList.toggle('dmMax',dmFull); };
$('#dmS').onclick=sendDM; $('#dmI').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendDM(); }});
function sendDM(){ const t=$('#dmI').value.trim(); if(!t||!state.dmWith) return; state.socket.emit('dm:send',{toId:state.dmWith.userId,text:t}); $('#dmI').value=''; $('#dmI').focus(); }

/* Ø¥Ø±Ø³Ø§Ù„ + Ø£ÙˆØ§Ù…Ø± Ø³Ù„Ø§Ø´ */
$('#send').onclick=send; $('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
function send(){ const t=$('#msg').value.trim(); if(!t) return; state.socket.emit('chat:msg',{text:t}); $('#msg').value=''; $('#msg').focus(); stickToBottom(true); }

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
$('#iAdmin').onclick=async()=>{
  if(state.role!=='owner' && state.role!=='admin' && state.role!=='mod'){ alert('Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·'); return; }
  $('#sheet').style.display='block';
  const bd=$('#sheetBd'); bd.innerHTML='';

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† â€” Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
  if(state.role==='owner'){
    const tools=document.createElement('div'); tools.className='rowAdmin';
    tools.innerHTML=`<strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</strong>
      <input id="mUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)" style="flex:1;min-width:160px;padding:8px;border:1px solid var(--line);border-radius:8px;background:#050608;color:#fff">
      <select id="mRole" class="b"><option value="mod">mod</option><option value="admin">admin</option></select>
      <input id="mPass" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="min-width:160px;padding:8px;border:1px solid var(--line);border-radius:8px;background:#050608;color:#fff">
      <button class="b" id="mSave">Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ«</button>
      <button class="b warn" id="mDel">Ø­Ø°Ù</button>`;
    bd.appendChild(tools);

    const listBox=document.createElement('div'); bd.appendChild(listBox);
    async function refresh(){
      try{
        const list=await get('/api/owner/mods',true);
        listBox.innerHTML=list.map(m=>`<div class="rowAdmin"><span class="b">${m.role}</span><strong style="direction:ltr">${m.username}</strong>${m.passHash?'<span class="b" style="opacity:.6">âœ… ÙƒÙ„Ù…Ø© Ø³Ø±</span>':''}</div>`).join('')||'<div class="rowAdmin"><em>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙˆÙ†.</em></div>';
      }catch(e){ listBox.innerHTML=`<div class="rowAdmin"><em>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: ${e.message||'Ø®Ø·Ø£'}</em></div>`; }
    }
    await refresh();

    function toast(m){ alert(m); }
    tools.querySelector('#mSave').onclick=async()=>{
      const u=$('#mUser').value.trim(), r=$('#mRole').value, p=$('#mPass').value.trim();
      if(!/^[A-Za-z0-9_.-]{3,20}$/.test(u)) return toast('Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ 3â€“20');
      try{
        const res=await fetch('/api/owner/mods',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.token},body:JSON.stringify({username:u,role:r,password:p||undefined})});
        const d=await res.json(); if(!res.ok||d.error) throw new Error(d.error||('HTTP '+res.status));
        $('#mPass').value=''; await refresh(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
      }catch(e){ toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+(e.message||'Ø®Ø·Ø£')); }
    };
    tools.querySelector('#mDel').onclick=async()=>{
      const u=$('#mUser').value.trim(); if(!u) return;
      try{
        const res=await fetch('/api/owner/mods/'+encodeURIComponent(u),{method:'DELETE',headers:{'Authorization':'Bearer '+state.token}});
        const d=await res.json(); if(!res.ok||d.error) throw new Error(d.error||('HTTP '+res.status));
        await refresh(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
      }catch(e){ toast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+(e.message||'Ø®Ø·Ø£')); }
    };

    /* === Ø³Ø¬Ù„ Ø§Ù„Ø®Ø§Øµ (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·) === */
    const dmBox=document.createElement('div'); dmBox.className='rowAdmin';
    dmBox.innerHTML=`
      <strong>Ø³Ø¬Ù„ Ø§Ù„Ø®Ø§Øµ (DM)</strong>
      <select id="dmLimit" class="b"><option value="200">Ø¢Ø®Ø± 200</option><option value="500">Ø¢Ø®Ø± 500</option><option value="1000">Ø¢Ø®Ø± 1000</option></select>
      <button class="b" id="dmLoad">Ø¹Ø±Ø¶</button>
      <button class="b warn" id="dmClear">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      <div id="dmList" style="width:100%;max-height:40vh;overflow:auto;margin-top:8px;border:1px solid var(--line);border-radius:8px;padding:8px;background:#0b0e14"></div>
    `;
    bd.appendChild(dmBox);

    dmBox.querySelector('#dmLoad').onclick = async ()=>{
      const limit = document.getElementById('dmLimit').value || 200;
      const r = await fetch('/api/owner/dm-log?limit='+limit,{headers:{Authorization:'Bearer '+state.token}});
      const arr = await r.json();
      const list = dmBox.querySelector('#dmList');
      list.innerHTML = arr.map(m=>`
        <div style="border-bottom:1px solid #1d2530;padding:6px 2px">
          <div style="font-size:12px;color:#9fb4c7">${new Date(m.ts).toLocaleString()}</div>
          <div><b style="direction:ltr">${m.from}</b> âŸ¶ <b style="direction:ltr">${m.to}</b></div>
          <div style="white-space:pre-wrap">${m.text ? m.text.replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])) : ''}</div>
        </div>
      `).join('') || '<em>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ© Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯.</em>';
    };
    dmBox.querySelector('#dmClear').onclick = async ()=>{
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø§ØµØŸ')) return;
      await fetch('/api/owner/dm-log/clear',{method:'POST',headers:{Authorization:'Bearer '+state.token}});
      dmBox.querySelector('#dmList').innerHTML = '<em>ØªÙ… Ø§Ù„Ù…Ø³Ø­.</em>';
    };

    /* === Audit + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª + ÙÙ„ØªØ± ÙƒÙ„Ù…Ø§Øª === */
    const auditBox=document.createElement('div'); auditBox.className='rowAdmin';
    auditBox.innerHTML=`
      <strong>Ø§Ù„Ø³Ø¬Ù„ (Audit)</strong>
      <button class="b" id="aLoad">Ø¹Ø±Ø¶ Ø¢Ø®Ø± 300</button>
      <button class="b warn" id="aClear">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      <div style="margin-top:6px;color:var(--muted)">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­ÙŠÙ‘Ø©: <span id="liveStats">â€”</span></div>
      <div id="aList" style="width:100%;max-height:40vh;overflow:auto;margin-top:8px;border:1px solid var(--line);border-radius:8px;padding:8px;background:#0b0e14"></div>

      <div style="margin-top:10px"><strong>ÙÙ„ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</strong></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <textarea id="badWords" style="flex:1;min-height:80px;background:#050608;color:#fff;border:1px solid var(--line);border-radius:8px;padding:8px" placeholder="ÙƒÙ„Ù…Ø© ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±"></textarea>
        <button class="b" id="badSave">Ø­ÙØ¸ Ø§Ù„ÙÙ„ØªØ±</button>
      </div>
    `;
    bd.appendChild(auditBox);

    auditBox.querySelector('#aLoad').onclick=async()=>{
      const arr=await get('/api/owner/audit?limit=300',true);
      auditBox.querySelector('#aList').innerHTML = arr.map(e=>`<div style="border-bottom:1px solid #1d2530;padding:4px 2px;font-family:ui-monospace,monospace;font-size:13px">${new Date(e.ts).toLocaleString()} â€” ${e.type} â€” ${(e.username||'')} ${(e.ip||'')} ${(e.deviceId||'')}</div>`).join('') || '<em>ÙØ§Ø±Øº</em>';
    };
    auditBox.querySelector('#aClear').onclick=async()=>{ if(!confirm('Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ'))return; await post('/api/owner/audit/clear',{},true); auditBox.querySelector('#aList').innerHTML='<em>ØªÙ… Ø§Ù„Ù…Ø³Ø­</em>'; };
    const live = ()=>{ const s=state.stats; auditBox.querySelector('#liveStats').textContent = s?`Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:${s.online} â€¢ Ø±Ø³Ø§Ø¦Ù„:${s.totalMsgs} â€¢ Ø®Ø§Øµ Ø§Ù„ÙŠÙˆÙ…:${s.dmToday}`:'â€”'; }; setInterval(live,1500);

    // ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ ÙÙ„ØªØ±
    try{
      const arr=await get('/api/owner/filters',true);
      auditBox.querySelector('#badWords').value = arr.join('\n');
    }catch{}
    auditBox.querySelector('#badSave').onclick=async()=>{
      const txt=auditBox.querySelector('#badWords').value||''; const arr=txt.split('\n').map(s=>s.trim()).filter(Boolean);
      await fetch('/api/owner/filters',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.token},body:JSON.stringify(arr)});
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
    };
  }

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±
  const holder=document.createElement('div'); holder.className='rowAdmin'; holder.innerHTML='<em>ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±â€¦</em>'; bd.appendChild(holder);
  try{
    const bans=await get('/api/admin/bans',true); holder.remove();
    if(!bans.length){ bd.innerHTML+='<div class="rowAdmin"><em>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø­Ø¸Ø±.</em></div>'; return; }
    bans.forEach(b=>{
      const r=document.createElement('div'); r.className='rowAdmin';
      r.innerHTML=`<span class="b" style="background:#0a1016;border-color:#253041">${b.targetType==='ip'?'IP':'Ø¬Ù‡Ø§Ø²'}</span>
                   <strong style="direction:ltr">${b.targetValue}</strong>
                   <span style="color:var(--muted);font-size:12px">${b.ts?new Date(b.ts).toLocaleString():''}</span>
                   <span class="b" style="opacity:.6">Ø¨ÙˆØ§Ø³Ø·Ø© ${b.by||'-'}</span>`;
      const un=document.createElement('button'); un.className='b warn'; un.textContent='ÙÙƒ Ø­Ø¸Ø±';
      un.onclick=async()=>{ await post('/api/admin/unban',{targetType:b.targetType,targetValue:b.targetValue},true); r.remove(); };
      r.appendChild(un); bd.appendChild(r);
    });
  }catch{}
};
document.getElementById('sheetX').onclick=()=> $('#sheet').style.display='none';

/* Ø£Ø¯ÙˆØ§Øª */
const tools=$('#tools'); 
document.getElementById('iTools').onclick=()=>{ tools.style.display = (tools.style.display==='block'?'none':'block'); };
document.addEventListener('click',e=>{ if(!tools.contains(e.target) && e.target.id!=='iTools') tools.style.display='none'; });
document.getElementById('tOpenDM').onclick=()=>{ if(!state.dmWith){ alert('Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ø³Ù…Ù‡ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø§Øµ.'); }else{ $('#dm').style.display='flex'; $('#dmI').focus(); } };
document.getElementById('iInfo').onclick=()=> alert('ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨ â€” Ù…Ø²Ø§ÙŠØ§: Ø£ØµØ¯Ù‚Ø§Ø¡/Ø¥Ø´Ø¹Ø§Ø±Ø§Øª/Ù…Ù„ÙØ§Øª/Ø£ÙˆØ§Ù…Ø±/Ù…Ø«Ø¨Ù‘Øª/Ø³Ø¬Ù„/ÙÙ„ØªØ±');
document.getElementById('myProfile').onclick=async()=>{
  const oldS = prompt('Ø§ÙƒØªØ¨ Ø­Ø§Ù„ØªÙƒ (status):', '');
  const oldA = prompt('Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© (avatar URL):', '');
  try{ await post('/api/profile',{status:oldS||'', avatar:oldA||''},true); alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); }catch(e){ alert('ÙØ´Ù„: '+(e.message||'Ø®Ø·Ø£')); }
};
document.getElementById('friendsBtn').onclick=()=>{
  alert('Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ: '+[...state.friends].join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
};

/* People Drawer */
$('#iPeople').onclick=()=> $('#drawer').style.display='block';
$('#closeDrawer').onclick=()=> $('#drawer').style.display='none';
$('#drawer').onclick=(e)=>{ if(e.target.id==='drawer') $('#drawer').style.display='none'; };

/* DM widget */
function showDM(userId,username){ state.dmWith={userId,username}; $('#dmT').textContent='Ø®Ø§Øµ: '+username; $('#dmB').innerHTML=''; $('#dm').style.display='flex'; $('#dmI').focus(); }
$('#dmX').onclick=()=> $('#dm').style.display='none'; $('#dmMin').onclick=()=> $('#dm').style.display='none';
let dmFull=false; $('#dmFull').onclick=()=>{ dmFull=!dmFull; $('#dm').classList.toggle('dmMax',dmFull); };
$('#dmS').onclick=sendDM; $('#dmI').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendDM(); }});
function sendDM(){ const t=$('#dmI').value.trim(); if(!t||!state.dmWith) return; state.socket.emit('dm:send',{toId:state.dmWith.userId,text:t}); $('#dmI').value=''; $('#dmI').focus(); }

/* Layout / iOS keyboard */
function layout(){ const vv=window.visualViewport, vvh=vv?vv.height:window.innerHeight; const topH=document.querySelector('.top').getBoundingClientRect().height; const dockH=document.querySelector('.dock').getBoundingClientRect().height; const h=Math.max(160,Math.round(vvh-topH-dockH)); M().style.height=h+'px'; }
let kbLoop=null; function startKBLoop(){ if(kbLoop) return; const step=()=>{ layout(); stickToBottom(); kbLoop=requestAnimationFrame(step); }; kbLoop=requestAnimationFrame(step); }
function stopKBLoop(){ if(kbLoop){ cancelAnimationFrame(kbLoop); kbLoop=null; } }
window.visualViewport && visualViewport.addEventListener('resize',()=>{ layout(); stickToBottom(); });
window.addEventListener('resize',()=>{ layout(); stickToBottom(); });
window.addEventListener('orientationchange',()=> setTimeout(()=>{ layout(); stickToBottom(true); },120));
document.addEventListener('focusin',e=>{ if(e.target.id==='msg'){ startKBLoop(); }});
document.addEventListener('focusout',e=>{ if(e.target.id==='msg'){ stopKBLoop(); setTimeout(()=>{ layout(); stickToBottom(); },0); }});
document.addEventListener('DOMContentLoaded',()=>{ layout(); stickToBottom(true); });

/* Helpers */
function toast(m){ const s=el('div','sys'); s.textContent=m; M().appendChild(s); stickToBottom(true); }
</script>
</body>
</html>
