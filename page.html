<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨ â€¢ old</title>
<style>
:root{--bg:#0b0c0f;--fg:#e7eaee;--mut:#a3aab5;--acc:#22b8ff;--line:#1c2027;--input:#0f1216;--fsize:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto}
.wrap{display:flex;flex-direction:column;height:100%}
.top{height:50px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;background:#0d0f13;border-bottom:1px solid var(--line)}
.actions{display:flex;gap:6px}
.icon{width:34px;height:34px;display:grid;place-items:center;background:#151922;border:1px solid var(--line);border-radius:8px;cursor:pointer}
.body{flex:1;display:flex;overflow:hidden}
.side{width:0;transition:.2s;overflow:auto;background:#11141a;border-left:1px solid var(--line)}
.side.open{width:240px}
.users{padding:8px;display:flex;flex-direction:column;gap:6px}
.user{padding:8px;border:1px solid var(--line);border-radius:8px;display:flex;justify-content:space-between;cursor:pointer}
.main{flex:1;display:flex;flex-direction:column}
.msgs{flex:1;overflow:auto;padding:10px;font-size:var(--fsize)}
.msg{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:flex-start;margin:6px 0;direction:rtl}
.name{text-align:right;color:#7dd3fc;cursor:pointer;font-size:calc(var(--fsize)*.95)}
.text{text-align:right;white-space:pre-wrap;word-break:break-word}
.sys{color:#9fb0c4;font-size:13px;margin:4px 0}
.inputBar{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line);background:#0d0f13}
.inputBar input{flex:1;height:40px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 10px;font-size:var(--fsize)}
.btn{background:var(--acc);color:#001b29;font-weight:700;border:0;border-radius:10px;padding:0 12px;cursor:pointer}
.menu{position:fixed;z-index:5000;background:#12151c;border:1px solid var(--line);border-radius:10px;min-width:160px;padding:4px}
.menu button{display:block;width:100%;padding:8px;text-align:right;background:#0f1218;color:var(--fg);border:0;border-radius:8px;margin:4px 0;cursor:pointer}

.login{position:fixed;inset:0;background:#0b0c0fe6;z-index:9999;display:flex;align-items:center;justify-content:center}
.login .box{background:#121419;padding:16px;border-radius:12px;width:90%;max-width:320px}
.login input{width:100%;margin:6px 0;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0f1216;color:var(--fg)}
.small{font-size:12px;color:#9fb0c4}

.pinned{padding:6px 10px;background:#0e1218;border-bottom:1px solid var(--line);color:#f7e7a8;display:none}
.pinned.show{display:block}
</style>
</head>
<body>
<div class="wrap" id="app" hidden>
  <div class="top">
    <div># Ø§Ù„Ø¹Ø±Ø¨</div>
    <div class="actions">
      <div class="icon" id="btnUsers" title="Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†">ğŸ‘¥</div>
      <div class="icon" id="btnProfile" title="Ù…Ù„ÙÙŠ">ğŸ§‘</div>
      <div class="icon" id="btnAdmin" title="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">âš™ï¸</div>
    </div>
  </div>

  <div class="body">
    <aside class="side" id="side"><div class="users" id="users"></div></aside>

    <section class="main">
      <div class="pinned" id="pinned"></div>
      <div class="msgs" id="msgs"></div>
      <div class="inputBar">
        <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <button class="btn" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </section>
  </div>
</div>

<!-- Login Ø«Ø§Ø¨ØªØ© ÙˆØ¨Ø³ÙŠØ·Ø© -->
<div class="login" id="login">
  <div class="box">
    <h3 style="margin:6px 0 10px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)">
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button class="btn" id="btnGo">Ø¯Ø®ÙˆÙ„</button>
    <div class="small" style="margin-top:6px">Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± Ù‡Ù†Ø§.</div>
  </div>
</div>

<!-- Profile -->
<div class="login" id="profileWin" style="display:none;background:#00000080">
  <div class="box" style="max-width:360px">
    <h3 style="margin:6px 0 10px">Ù…Ù„ÙÙŠ</h3>
    <input id="prAvatar" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <input id="prStatus" placeholder="Ø­Ø§Ù„Ø© Ù‚ØµÙŠØ±Ø©">
    <div style="margin:8px 0">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·: <input id="prFont" type="range" min="14" max="24" value="16"> <span id="prFontLbl"></span></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="prSave">Ø­ÙØ¸</button>
      <button class="btn" id="prClose" style="background:#333;color:#eee">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Admin -->
<div class="login" id="adminWin" style="display:none;background:#00000080">
  <div class="box" style="max-width:520px">
    <h3 style="margin:6px 0 10px">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
    <div id="whoami" class="small" style="margin:6px 0 10px"></div>
    <div style="display:flex;gap:6px;align-items:center">
      <input id="admTarget" placeholder="UserName/UserId Ø£Ùˆ IP/DeviceId" style="flex:1">
      <select id="adminAction">
        <option value="clear">Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</option>
        <option value="pin">ØªØ«Ø¨ÙŠØª Ø±Ø³Ø§Ù„Ø©</option>
        <option value="kick">Ø·Ø±Ø¯</option>
        <option value="banIP">Ø­Ø¸Ø± IP</option>
        <option value="banDev">Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø²</option>
        <option value="unban">ÙÙƒ Ø­Ø¸Ø±</option>
      </select>
      <button class="btn" id="admDo">ØªÙ†ÙÙŠØ°</button>
    </div>
    <div style="margin-top:10px">
      <div class="small">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±:</div>
      <div id="bansBox" class="small">â€”</div>
    </div>
    <div id="modsSec" style="margin-top:10px;display:none">
      <div class="small">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)</div>
      <div style="display:flex;gap:6px;margin:6px 0">
        <input id="modName" placeholder="Ø§Ø³Ù… Ù…Ø´Ø±Ù">
        <input id="modPass" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±">
      </div>
      <div style="display:flex;gap:6px;margin-bottom:8px">
        <button class="btn" id="modSave">Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn" id="modDel" style="background:#e11d48">Ø­Ø°Ù</button>
      </div>
      <div id="modsList" class="small">â€”</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="admClose" style="background:#333;color:#eee">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=s=>document.querySelector(s);
let sock, me={}, userlist=[], mentionName='';

const msgs=$('#msgs'), users=$('#users'), pinned=$('#pinned');

// Ø£Ø¯ÙˆØ§Øª
function el(t,c,txt){const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;}
function scrollBottom(){ msgs.scrollTop = msgs.scrollHeight + 200; }
function iconRole(r){ if(r==='owner')return '& '; if(r==='admin')return 'â˜… '; if(r==='mod')return 'âœ¦ '; return ''; }
async function api(url,data,method='POST'){ const r=await fetch(url,{method,headers:{'Content-Type':'application/json',...(localStorage.token?{'Authorization':'Bearer '+localStorage.token}:{})}, body: method==='GET'?undefined:JSON.stringify(data)}); const j=await r.json().catch(()=>({})); if(!r.ok) throw j; return j; }
function deviceId(){ let d=localStorage.deviceId; if(!d){ d='dev-'+Math.random().toString(36).slice(2)+Date.now(); localStorage.deviceId=d; } return d; }

// Ø¯Ø®ÙˆÙ„
async function doLogin(){
  try{
    const j=await api('/api/login-smart',{username:$('#user').value,password:$('#pass').value,deviceId:deviceId()});
    localStorage.token=j.token; me=j; mentionName=j.username;
    $('#login').remove(); $('#app').hidden=false; boot();
  }catch(e){ alert(e?.error||'ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
}
$('#btnGo').onclick=doLogin;
document.addEventListener('keydown', e=>{ if(e.key==='Enter' && $('#login')) doLogin(); });

// Ø±Ø³Ø§Ø¦Ù„
function isMention(txt){ if(!txt||!mentionName) return false; return new RegExp('(^|\\s)@'+mentionName.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'(\\b|\\s)','i').test(txt); }
function addMsg(name,text,role){
  const m=el('div','msg');
  const n=el('div','name', iconRole(role)+name);
  n.onclick=(ev)=> openUserMenuByName(name, ev.clientX, ev.clientY);
  const t=el('div','text', text);
  if(isMention(text)){ t.style.background='#1a2130'; t.style.borderRadius='8px'; t.style.padding='6px 8px'; }
  m.append(n,t); msgs.append(m); scrollBottom();
}
function addSys(t){ msgs.append(el('div','sys','â€¢ '+t)); scrollBottom(); }

// Ù‚Ø§Ø¦Ù…Ø© Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† + Ù‚Ø§Ø¦Ù…Ø© Ø§Ø³Ù…
function renderUsers(){
  users.innerHTML='';
  userlist.forEach(u=>{
    const li=el('div','user');
    const left=document.createElement('div');
    const avatar=document.createElement('span'); avatar.textContent='ğŸ–¼ï¸ '; // Ù…ÙƒØ§Ù† ØµÙˆØ±Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
    left.append(avatar, document.createTextNode(iconRole(u.role)+u.username));
    const right=el('div','', u.status||'');
    li.append(left,right);
    li.onclick=(ev)=> openUserMenu(u, ev.clientX, ev.clientY);
    users.append(li);
  });
}
function openUserMenuByName(name,x,y){ const u=userlist.find(n=>n.username===name); if(u) openUserMenu(u,x,y); }
function openUserMenu(u,x,y){
  closeMenus();
  const menu=el('div','menu'); menu.style.left=(x-160)+'px'; menu.style.top=(y+6)+'px';
  const B=(t,fn)=>{ const b=document.createElement('button'); b.textContent=t; b.onclick=()=>{fn(); closeMenus();}; return b; };
  menu.append(B('Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©', ()=>{ const inp=$('#msgInput'); inp.value=(inp.value?inp.value+'\n':'')+`@${u.username} `; inp.focus(); }));
  if(['owner','admin','mod'].includes(me.role)){
    menu.append(B('Ø·Ø±Ø¯', ()=> sock.emit('admin:kick', u.userId)));
    menu.append(B('Ø­Ø¸Ø± (Ø¬Ù‡Ø§Ø²)', ()=> sock.emit('admin:ban', {userId:u.userId})));
  }
  document.body.append(menu);
  document.addEventListener('click', function handler(e){ if(!menu.contains(e.target)){ closeMenus(); document.removeEventListener('click', handler);} }, {once:true});
}
function closeMenus(){ document.querySelectorAll('.menu').forEach(m=>m.remove()); }

// Ø¥Ø±Ø³Ø§Ù„
$('#sendBtn').onclick=()=>{ const v=$('#msgInput').value.trim(); if(!v) return; sock.emit('msg', v); $('#msgInput').value=''; };

// Profile + Ø­Ø¬Ù… Ø®Ø·
function applyFont(sz){ document.documentElement.style.setProperty('--fsize', sz+'px'); localStorage.fsize=sz; $('#prFontLbl').textContent=sz+'px'; }
(function initFont(){ const s=parseInt(localStorage.fsize||'16',10); applyFont(s); })();
$('#prFont').oninput = e=> applyFont(parseInt(e.target.value,10));
async function openProfile(){ $('#profileWin').style.display='flex'; try{ const j=await api('/api/profile',null,'GET'); $('#prAvatar').value=j.avatar||''; $('#prStatus').value=j.status||''; }catch{} }
$('#prSave').onclick=async()=>{ try{ await api('/api/profile',{avatar:$('#prAvatar').value.trim(),status:$('#prStatus').value.trim()}); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); $('#profileWin').style.display='none'; }catch(e){ alert(e?.error||'Ø®Ø·Ø£'); } };
$('#prClose').onclick=()=> $('#profileWin').style.display='none';

// Ø¥Ø¯Ø§Ø±Ø©
async function openAdmin(){
  $('#adminWin').style.display='flex';
  $('#whoami').textContent = `Ø§Ø³Ù…Ùƒ: ${me.username} â€” Ø§Ù„Ø¯ÙˆØ±: ${me.role}`;
  // bans
  if(['owner','admin','mod'].includes(me.role)){
    try{
      const j=await api('/api/admin/bans',null,'GET');
      const box=$('#bansBox'); box.innerHTML='';
      if(!j.bans?.length) box.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø­Ø¸Ø±.';
      else j.bans.forEach(b=> box.append(el('div',null,(b.ip?'IP:'+b.ip:'DEV:'+b.deviceId)+' â€” '+(b.by||'ØŸ'))));
    }catch{ $('#bansBox').textContent='ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø±.'; }
  }
  // mods (owner only)
  $('#modsSec').style.display = (me.role==='owner') ? 'block' : 'none';
  if(me.role==='owner') loadMods();
}
async function loadMods(){ try{ const j=await api('/api/owner/mods',null,'GET'); const box=$('#modsList'); box.innerHTML=''; if(!j.mods?.length) box.textContent='â€”'; else j.mods.forEach(m=>box.append(el('div',null,'â€¢ '+m.username))); }catch{ $('#modsList').textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„'; } }
async function saveMod(){ try{ await api('/api/owner/mods',{username:$('#modName').value.trim(),password:$('#modPass').value.trim()}); alert('Ø­ÙÙØ¸'); loadMods(); }catch(e){ alert(e?.error||'Ø®Ø·Ø£'); } }
async function delMod(){ try{ await api('/api/owner/mods',{username:$('#modName').value.trim(),remove:true}); alert('Ø­ÙØ°Ù'); loadMods(); }catch(e){ alert(e?.error||'Ø®Ø·Ø£'); } }

$('#modSave').onclick=saveMod; $('#modDel').onclick=delMod;
$('#admClose').onclick=()=> $('#adminWin').style.display='none';
$('#btnUsers').onclick=()=> $('#side').classList.toggle('open');
$('#btnProfile').onclick=openProfile;
$('#btnAdmin').onclick=openAdmin;

$('#admDo').onclick=()=>{
  const act=$('#adminAction').value, t=$('#admTarget').value.trim();
  if(act==='clear') sock.emit('admin:clear');
  else if(act==='pin') sock.emit('admin:pin', t);
  else if(act==='kick'){ const id=findUserId(t); if(id) sock.emit('admin:kick', id); }
  else if(act==='banIP'){ sock.emit('admin:ban',{ip:t}); }
  else if(act==='banDev'){ const id=findUserId(t); if(id) sock.emit('admin:ban',{userId:id}); else sock.emit('admin:ban',{deviceId:t}); }
  else if(act==='unban'){ if(t.includes('.')) sock.emit('admin:unban',{ip:t}); else sock.emit('admin:unban',{deviceId:t}); }
  $('#admTarget').value='';
};
function findUserId(txt){ const byName=userlist.find(u=>u.username.toLowerCase()===txt.toLowerCase()); if(byName) return byName.userId; const byId=userlist.find(u=>u.userId===txt); return byId?.userId||null; }

// Socket boot
function boot(){
  sock=io('/',{auth:{token:localStorage.token}});
  sock.on('connect',()=> addSys('Ù…ØªØµÙ„.'));
  sock.on('disconnect',()=> addSys('Ø§Ù†Ù‚Ø·Ø¹.'));
  sock.on('userlist', l=>{ userlist=l||[]; renderUsers(); });
  sock.on('profile:update', p=>{ const u=userlist.find(x=>x.userId===p.userId); if(u){ Object.assign(u,p); renderUsers(); } });
  sock.on('msg', m=> addMsg(m.from,m.text,m.role));
  sock.on('sys', s=> addSys(s.text));
  sock.on('clear', ()=> msgs.innerHTML='');
  sock.on('pin', txt=>{ pinned.textContent='ğŸ“Œ '+txt; pinned.classList.add('show'); });

  // ØªØ±Ø­ÙŠØ¨
  addMsg('ChanServ','Ø£Ù‡Ù„Ù‹Ø§ Ø¨Ùƒ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø¹Ø±Ø¨!\nâ¤ï¸ğŸ˜ğŸ¥³\nâ˜ºï¸ğŸ˜\nğŸ¥³ğŸ¥³\nğŸ˜œ','sys');
}

window.addEventListener('load', ()=> $('#user')?.focus());
</script>
</body>
</html>
