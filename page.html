<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>غرفة العرب</title>
<style>
:root{
  --bg:#0b0c0f; --fg:#e7eaee; --mut:#a3aab5; --acc:#22b8ff;
  --line:#1c2027; --input:#0f1216; --fsize:16px;
}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto}
body{background:var(--bg);color:var(--fg);}
.wrap{display:flex;flex-direction:column;height:100%}
.top{height:50px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;background:#0d0f13;border-bottom:1px solid var(--line)}
.actions{display:flex;gap:6px}
.icon{width:34px;height:34px;display:grid;place-items:center;background:#151922;border:1px solid var(--line);border-radius:8px;cursor:pointer}
.body{flex:1;display:flex;overflow:hidden}
.side{width:0;transition:.2s;width:0;overflow:auto;background:#11141a;border-left:1px solid var(--line)}
.side.open{width:240px}
.users{padding:8px;display:flex;flex-direction:column;gap:6px}
.user{padding:8px;border:1px solid var(--line);border-radius:8px;display:flex;justify-content:space-between;cursor:pointer}
.main{flex:1;display:flex;flex-direction:column}
.msgs{flex:1;overflow:auto;padding:10px;font-size:var(--fsize)}
.msg{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:flex-start;margin:6px 0;direction:rtl}
.name{text-align:right;color:#7dd3fc;cursor:pointer;font-size:calc(var(--fsize)*.95)}
.text{text-align:right;white-space:pre-wrap;word-break:break-word}
.sys{color:#9fb0c4;font-size:13px;margin:4px 0}
.inputBar{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line);background:#0d0f13}
.inputBar input{flex:1;height:40px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 10px;font-size:var(--fsize)}
.btn{background:var(--acc);color:#001b29;font-weight:700;border:0;border-radius:10px;padding:0 12px;cursor:pointer}
.menu{position:fixed;z-index:5000;background:#12151c;border:1px solid var(--line);border-radius:10px;min-width:160px;padding:4px}
.menu button{display:block;width:100%;padding:8px;text-align:right;background:#0f1218;color:var(--fg);border:0;border-radius:8px;margin:4px 0;cursor:pointer}
.dm,.panel{position:fixed;inset:20% 10% auto 10%;background:#12151c;border:1px solid var(--line);border-radius:10px;display:none;flex-direction:column}
.dm .list{flex:1;overflow:auto;padding:8px}
.dm .send{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
.dm .send input{flex:1;height:36px;border-radius:8px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 8px}
.panel .sec{padding:8px;border-bottom:1px solid var(--line)}
.login{position:fixed;inset:0;background:#0b0c0fe6;z-index:9999;display:flex;align-items:center;justify-content:center}
.login .box{background:#121419;padding:16px;border-radius:12px;width:90%;max-width:320px}
.login input{width:100%;margin:6px 0;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0f1216;color:var(--fg)}
.avatar{width:20px;height:20px;border-radius:50%;margin-left:6px;object-fit:cover}
</style>
</head>
<body>
<div class="wrap" id="app" hidden>
  <div class="top">
    <div># العرب</div>
    <div class="actions">
      <div class="icon" id="btnUsers">👥</div>
      <div class="icon" id="btnDM">✉️</div>
      <div class="icon" id="btnProfile">🧑</div>
      <div class="icon" id="btnAdmin">⚙️</div>
    </div>
  </div>
  <div class="body">
    <aside class="side" id="side"><div class="users" id="users"></div></aside>
    <section class="main">
      <div class="msgs" id="msgs"></div>
      <div class="inputBar">
        <input id="msgInput" placeholder="اكتب رسالة...">
        <button class="btn" id="sendBtn">إرسال</button>
      </div>
    </section>
  </div>
</div>

<!-- Login -->
<div class="login" id="login">
  <div class="box">
    <h3>تسجيل الدخول</h3>
    <input id="user" placeholder="اسم المستخدم (إنجليزي)">
    <input id="pass" type="password" placeholder="كلمة السر (اختياري)">
    <button class="btn" id="btnGo">دخول</button>
  </div>
</div>

<!-- DM -->
<div class="dm" id="dmWin">
  <div style="padding:6px;display:flex;justify-content:space-between;align-items:center">
    <b id="dmTitle">خاص</b><button class="btn" id="dmClose">×</button>
  </div>
  <div class="list" id="dmList"></div>
  <div class="send"><input id="dmText"><button class="btn" id="dmSend">إرسال</button></div>
</div>

<!-- Profile -->
<div class="panel" id="profileWin">
  <div class="sec"><input id="prAvatar" placeholder="رابط الصورة"></div>
  <div class="sec"><input id="prStatus" placeholder="الحالة"></div>
  <div class="sec">
    حجم الخط: <input id="prFont" type="range" min="14" max="24" value="16">
    <span id="prFontLbl"></span>
  </div>
  <div class="sec"><button class="btn" id="prSave">حفظ</button></div>
</div>

<!-- Admin -->
<div class="panel" id="adminWin">
  <div class="sec" id="whoami"></div>
  <div class="sec">
    <input id="admTarget" placeholder="اسم / IP / Device">
    <select id="adminAction">
      <option value="clear">مسح</option>
      <option value="pin">تثبيت</option>
      <option value="kick">طرد</option>
      <option value="banIP">حظر IP</option>
      <option value="banDev">حظر جهاز</option>
      <option value="unban">فك حظر</option>
    </select>
    <button class="btn" id="admDo">تنفيذ</button>
  </div>
  <div class="sec"><div id="bansBox">—</div></div>
  <div class="sec" id="modsSec" style="display:none">
    <input id="modName" placeholder="اسم مشرف">
    <input id="modPass" placeholder="كلمة سر">
    <button class="btn" id="modSave">حفظ</button>
    <button class="btn" id="modDel" style="background:#e11d48">حذف</button>
    <div id="modsList"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=s=>document.querySelector(s);
let sock,me={},userlist=[],mentionName='',dmTarget=null,unread=0;
function el(t,c,txt){const e=document.createElement(t);if(c)e.className=c;if(txt!=null)e.textContent=txt;return e;}
function scrollBottom(){msgs.scrollTop=msgs.scrollHeight;}
function iconRole(r){if(r==='owner')return '& ';if(r==='admin')return '★ ';if(r==='mod')return '✦ ';return '';}

async function api(url,data,method='POST'){
  const r=await fetch(url,{method,headers:{'Content-Type':'application/json',...(localStorage.token?{'Authorization':'Bearer '+localStorage.token}:{})},body:method==='GET'?undefined:JSON.stringify(data)});
  const j=await r.json().catch(()=>({}));if(!r.ok)throw j;return j;
}

async function doLogin(){
  try{
    const j=await api('/api/login-smart',{username:$('#user').value,password:$('#pass').value,deviceId:deviceId()});
    localStorage.token=j.token;me=j;mentionName=j.username;
    $('#login').remove();$('#app').hidden=false;boot();
  }catch(e){alert(e?.error||'فشل الدخول');}
}
$('#btnGo').onclick=doLogin;
document.addEventListener('keydown',e=>{if(e.key==='Enter' && $('#login'))doLogin();});

function deviceId(){let d=localStorage.deviceId;if(!d){d='dev-'+Math.random().toString(36).slice(2)+Date.now();localStorage.deviceId=d;}return d;}
function isMention(t){if(!t||!mentionName)return false;return new RegExp('@'+mentionName,'i').test(t);}

function addMsg(n,txt,role){const m=el('div','msg');const nm=el('div','name',iconRole(role)+n);nm.onclick=(ev)=>openUserMenuByName(n,ev.clientX,ev.clientY);const t=el('div','text',txt);if(isMention(txt))t.style.background='#1a2130';m.append(nm,t);msgs.append(m);scrollBottom();}
function addSys(t){msgs.append(el('div','sys',t));scrollBottom();}

function renderUsers(){users.innerHTML='';userlist.forEach(u=>{const li=el('div','user');const left=document.createElement('div');const av=document.createElement('img');av.className='avatar';av.src=u.avatar||'';left.append(av,document.createTextNode(iconRole(u.role)+u.username));li.append(left,el('div','',u.status||''));li.onclick=(ev)=>openUserMenu(u,ev.clientX,ev.clientY);users.append(li);});}

function openUserMenuByName(name,x,y){const u=userlist.find(n=>n.username===name);if(u)openUserMenu(u,x,y);}
function openUserMenu(u,x,y){closeMenus();const menu=el('div','menu');menu.style.left=x+'px';menu.style.top=y+'px';const b=(t,f)=>{const bt=document.createElement('button');bt.textContent=t;bt.onclick=()=>{f();closeMenus();};return bt;};menu.append(b('رد',()=>{$('#msgInput').value+='@'+u.username+' ';$('#msgInput').focus();}));menu.append(b('خاص',()=>chooseDM(u.userId,u.username)));if(['owner','admin','mod'].includes(me.role)){menu.append(b('طرد',()=>sock.emit('admin:kick',u.userId)));menu.append(b('حظر جهاز',()=>sock.emit('admin:ban',{userId:u.userId})));}document.body.append(menu);document.addEventListener('click',e=>{if(!menu.contains(e.target))closeMenus();},{once:true});}
function closeMenus(){document.querySelectorAll('.menu').forEach(m=>m.remove());}

function chooseDM(id,name){dmTarget=id;$('#dmWin').style.display='flex';$('#dmTitle').textContent='خاص مع '+name;}
$('#dmSend').onclick=()=>{if(!dmTarget)return;const v=$('#dmText').value.trim();if(!v)return;sock.emit('dm',{toUserId:dmTarget,text:v});$('#dmText').value='';};
$('#dmClose').onclick=()=>$('#dmWin').style.display='none';

$('#btnUsers').onclick=()=>$('#side').classList.toggle('open');
$('#btnProfile').onclick=()=>$('#profileWin').style.display='flex';
$('#prSave').onclick=async()=>{await api('/api/profile',{avatar:$('#prAvatar').value,status:$('#prStatus').value});alert('تم الحفظ');$('#profileWin').style.display='none';};
$('#btnAdmin').onclick=()=>$('#adminWin').style.display='flex';
$('#admDo').onclick=async()=>{const t=$('#admTarget').value.trim(),a=$('#adminAction').value;if(a==='clear')sock.emit('admin:clear');else if(a==='pin')sock.emit('admin:pin',t);else if(a==='kick')sock.emit('admin:kick',findId(t));else if(a==='banIP')sock.emit('admin:ban',{ip:t});else if(a==='banDev')sock.emit('admin:ban',{deviceId:t});else if(a==='unban'){if(t.includes('.'))sock.emit('admin:unban',{ip:t});else sock.emit('admin:unban',{deviceId:t});}};
function findId(txt){const u=userlist.find(x=>x.username.toLowerCase()===txt.toLowerCase());return u?u.userId:null;}

function applyFont(sz){document.documentElement.style.setProperty('--fsize',sz+'px');localStorage.fsize=sz;$('#prFontLbl').textContent=sz+'px';}
(function(){const s=parseInt(localStorage.fsize||'16',10);applyFont(s);$('#prFont').value=s;})();$('#prFont').oninput=e=>applyFont(e.target.value);

function boot(){sock=io('/',{auth:{token:localStorage.token}});sock.on('connect',()=>addSys('متصل.'));sock.on('disconnect',()=>addSys('انقطع.'));sock.on('msg',m=>addMsg(m.from,m.text,m.role));sock.on('sys',s=>addSys(s.text));sock.on('clear',()=>msgs.innerHTML='');sock.on('pin',t=>addSys('📌 '+t));sock.on('userlist',l=>{userlist=l;renderUsers();});sock.on('profile:update',p=>{const u=userlist.find(x=>x.userId===p.userId);if(u){Object.assign(u,p);renderUsers();}});sock.on('dm',m=>{addSys('DM من '+m.from+': '+m.text);});sock.on('dm:sent',m=>{addSys('DM إلى '+m.toId+': '+m.text);});}
$('#sendBtn').onclick=()=>{const v=$('#msgInput').value.trim();if(v){sock.emit('msg',v);$('#msgInput').value='';}};
</script>
</body>
</html>
