<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ุบุฑูุฉ ุงูุนุฑุจ</title>
<style>
:root{--bg:#0b0c0f;--fg:#e7eaee;--muted:#a3aab5;--accent:#22b8ff;--card:#121419;--input:#0f1216;--line:#1c2027;--good:#65f5a1;--bad:#ff7d7d}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.wrap{display:flex;flex-direction:column;min-height:100%;position:relative}
.top{height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid var(--line);background:#0d0f13;position:sticky;top:0;z-index:5}
.top .ttl{font-weight:700}
.actions{display:flex;gap:8px}
.icon{width:36px;height:36px;border-radius:10px;background:#151922;border:1px solid var(--line);display:grid;place-items:center;cursor:pointer}
.icon:active{transform:scale(.98)}

.body{display:flex;min-height:0;flex:1}
.side{width:0;transition:width .2s ease;overflow:hidden;border-left:1px solid var(--line)}
.side.open{width:260px}
.users{padding:8px;display:flex;flex-direction:column;gap:6px}
.user{display:flex;justify-content:space-between;gap:6px;padding:8px;border-radius:10px;background:#11141a;border:1px solid var(--line);cursor:pointer}
.user .r{opacity:.7}

.main{flex:1;display:flex;flex-direction:column;min-width:0}
.pinned{min-height:0;padding:6px 10px;background:#0e1218;border-bottom:1px solid var(--line);color:#f7e7a8;display:none}
.pinned.show{display:block}
.msgs{flex:1;overflow:auto;scroll-behavior:smooth;padding:10px 12px}
.msg{display:flex;gap:10px;align-items:flex-start;margin:8px 0}
.msg .name{min-width:92px;color:#7dd3fc}
.msg .text{white-space:pre-wrap;word-break:break-word}
.sys{color:#a7b0be;font-size:13px;opacity:.85}

.inputBar{position:sticky;bottom:0;z-index:5;border-top:1px solid var(--line);background:#0d0f13;padding:10px;display:flex;gap:10px;align-items:center}
.inputBar input{flex:1;height:44px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 12px;font-size:16px}
.btn{height:44px;min-width:80px;border:0;border-radius:10px;background:var(--accent);color:#001b29;font-weight:700}
.btn:active{opacity:.85}

/* Login */
.login{position:fixed;inset:0;background:#0b0c0fe6;z-index:99999;display:flex;align-items:center;justify-content:center}
.login .box{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
.row{display:flex;gap:10px;margin:10px 0}
.input{height:44px;background:var(--input);border:1px solid var(--line);border-radius:10px;color:var(--fg);padding:0 12px;flex:1}

/* DM window */
.dm{position:fixed;inset:auto 8px 72px auto;right:8px;width:min(360px,92vw);background:#12151c;border:1px solid var(--line);border-radius:14px;display:none}
.dm .hd{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--line)}
.dm .list{max-height:45vh;overflow:auto;padding:8px}
.dm .item{background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0}
.dm .send{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
.dm .send input{flex:1;height:40px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 10px}

/* Admin panel (ูุงูู/ุฃุฏูู/ูุดุฑู) */
.panel{position:fixed;inset:auto 8px 72px 8px;background:#12151c;border:1px solid var(--line);border-radius:14px;display:none}
.panel .hd{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line)}
.panel .sec{padding:10px;border-bottom:1px solid var(--line)}
.panel .sec:last-child{border-bottom:0}
.panel label{display:block;margin-bottom:6px;color:#9fb0c4}
.panel input, .panel select {width:100%;height:40px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--fg);padding:0 10px;margin:6px 0}
.panel .row{display:flex;gap:8px}
.panel .row > *{flex:1}

.badge{display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:#e11d48;color:#fff;font-size:12px;margin-right:6px}
</style>
</head>
<body>
<div class="wrap" id="app" hidden>
  <div class="top">
    <div class="ttl"># ุงูุนุฑุจ</div>
    <div class="actions">
      <div class="icon" id="btnUsers" title="ุงููุชูุงุฌุฏูู">๐ฅ</div>
      <div class="icon" id="btnDM" title="ุงูุฑุณุงุฆู ุงูุฎุงุตุฉ">โ๏ธ <span id="dmBadge" style="display:none" class="badge">0</span></div>
      <div class="icon" id="btnAdmin" title="ุฃุฏูุงุช ุงูุฅุฏุงุฑุฉ">๐งฐ</div>
    </div>
  </div>

  <div class="body">
    <aside class="side" id="side">
      <div class="users" id="users"></div>
    </aside>

    <section class="main">
      <div class="pinned" id="pinned"></div>
      <div class="msgs" id="msgs"></div>
      <div class="inputBar">
        <button class="btn" id="sendBtn" type="button">ุฅุฑุณุงู</button>
        <input id="msgInput" placeholder="ุงูุชุจ ุฑุณุงูุฉ..." autocomplete="off" inputmode="text">
      </div>
    </section>
  </div>
</div>

<!-- Login -->
<div class="login" id="login">
  <div class="box">
    <h2>ุชุณุฌูู ุงูุฏุฎูู</h2>
    <div class="row"><input id="user" class="input" placeholder="ุงุณู ุงููุณุชุฎุฏู (ุฅูุฌููุฒู)"></div>
    <div class="row"><input id="pass" class="input" placeholder="ูููุฉ ุงูุณุฑ (ูุงุฑุบุฉ = ูุณุชุฎุฏู)" type="password"></div>
    <div class="row" style="justify-content:flex-end"><button class="btn" id="btnGo" type="button">ุฏุฎูู</button></div>
  </div>
</div>

<!-- DM window -->
<div class="dm" id="dmWin">
  <div class="hd"><div>ุฎุงุต</div><button class="btn" id="dmClose" style="min-width:60px">ุฅุบูุงู</button></div>
  <div class="list" id="dmList"></div>
  <div class="send">
    <input id="dmText" placeholder="ุงูุชุจ ุฑุณุงูุฉ ุฎุงุตุฉ...">
    <button class="btn" id="dmSend" style="min-width:60px">ุฅุฑุณุงู</button>
  </div>
</div>

<!-- Admin panel -->
<div class="panel" id="adminWin">
  <div class="hd"><div>ููุญุฉ ุงูุฅุฏุงุฑุฉ</div><button class="btn" id="admClose" style="min-width:60px">ุฅุบูุงู</button></div>

  <div class="sec">
    <div class="row">
      <select id="adminAction">
        <option value="clear">ูุณุญ ุงูุฏุฑุฏุดุฉ</option>
        <option value="pin">ุชุซุจูุช ุฑุณุงูุฉ</option>
        <option value="kick">ุทุฑุฏ ุนุถู</option>
        <option value="ban">ุญุธุฑ ุนุถู</option>
        <option value="unban">ูู ุญุธุฑ (IP/ุฌูุงุฒ)</option>
      </select>
      <input id="admTarget" placeholder="UserId / IP / DeviceId / ูุต ุงูุชุซุจูุช">
    </div>
    <button class="btn" id="admDo">ุชูููุฐ</button>
  </div>

  <div class="sec" id="whoami" style="font-size:13px;color:#9fb0c4"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=s=>document.querySelector(s), app=$('#app'), login=$('#login');
const msgs=$('#msgs'), users=$('#users'), side=$('#side'), pinned=$('#pinned');
const dmWin=$('#dmWin'), dmList=$('#dmList'), dmText=$('#dmText'), dmBadge=$('#dmBadge');
let sock=null, me={}, userlist=[], dmTarget=null, unread=0;

// ุฃุฏูุงุช
function el(t,c,txt){const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;}
function scrollBottom(){ msgs.scrollTop = msgs.scrollHeight + 200; }
function deviceId(){ let d=localStorage.deviceId; if(!d){ d='dev-'+Math.random().toString(36).slice(2)+Date.now(); localStorage.deviceId=d;} return d; }
async function api(url,data){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}); const j=await r.json().catch(()=>({})); if(!r.ok) throw j; return j; }

// ุฏุฎูู
async function doLogin(){
  const username=$('#user').value, password=$('#pass').value;
  try{
    const j=await api('/api/login-smart',{username,password,deviceId:deviceId()});
    localStorage.token=j.token; me=j;
    login.style.display='none'; app.hidden=false;
    boot();
  }catch(e){ alert(e?.error||'ูุดู ุงูุฏุฎูู'); }
}

function boot(){
  // ุณููุช
  sock=io('/',{ auth:{ token: localStorage.token } });

  sock.on('connect', ()=> addSys('ูุชุตู. ุฃููุงู '+me.username));
  sock.on('disconnect', ()=> addSys('ุงููุทุน ุงูุงุชุตุงู.'));

  sock.on('userlist', list=>{
    userlist=list||[]; renderUsers();
  });

  sock.on('msg', m=>{
    addMsg(m.from, m.text, m.role);
  });

  sock.on('sys', s=>{
    addSys(s.text);
  });

  sock.on('clear', ()=>{ msgs.innerHTML=''; pinned.classList.remove('show'); });

  sock.on('pin', txt=>{
    pinned.textContent='๐ '+txt; pinned.classList.add('show');
  });

  sock.on('dm', m=>{
    unread++; dmBadge.style.display='inline-block'; dmBadge.textContent=unread;
    addDM(m.from, m.text, m.t);
  });

  sock.on('dm:sent', m=>{
    addDM('ุฃูุง โ '+(getUser(m.toId)?.username||m.toId), m.text, m.t);
  });

  // ุฑุณุงูุฉ ุชุฑุญูุจ
  addMsg('ChanServ','ุฃูููุง ุจู ูู ุบุฑูุฉ ุงูุนุฑุจ!\nโค๏ธ๐๐ฅณ\nโบ๏ธ๐\n๐ฅณ๐ฅณ\n๐','sys');

  // UI
  $('#sendBtn').onclick=sendNow;
  $('#msgInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendNow(); }});
  $('#btnUsers').onclick=()=> side.classList.toggle('open');
  $('#btnDM').onclick=openDM;
  $('#dmClose').onclick=()=> dmWin.style.display='none';
  $('#dmSend').onclick=sendDM;

  $('#btnAdmin').onclick=openAdmin;
  $('#admClose').onclick=()=> $('#adminWin').style.display='none';
  $('#admDo').onclick=doAdmin;

  // iOS keyboard padding
  const pad=el('div'); pad.style.height='0px'; msgs.after(pad);
  window.visualViewport && window.visualViewport.addEventListener('resize', ()=>{
    const gap = Math.max(0, window.innerHeight - window.visualViewport.height);
    pad.style.height = gap ? (gap+10)+'px' : '0px';
    scrollBottom();
  });
}

function addMsg(name,text,role){
  const m=el('div','msg');
  const n=el('div','name', name+(role&&role!=='user'?' ยท '+role:''));
  const t=el('div','text', text);
  m.append(n,t); msgs.append(m); scrollBottom();
}
function addSys(t){ const s=el('div','sys','โข '+t); msgs.append(s); scrollBottom(); }

function sendNow(){
  const v=$('#msgInput').value.trim(); if(!v) return;
  sock.emit('msg', v); $('#msgInput').value=''; scrollBottom();
}

// ุงููุชูุงุฌุฏูู
function renderUsers(){
  users.innerHTML='';
  userlist.forEach(u=>{
    const li=el('div','user');
    li.append(el('div',null,u.username), el('div','r',u.role));
    li.onclick=()=> chooseDM(u.userId);
    users.append(li);
  });
}
function getUser(id){ return userlist.find(u=>u.userId===id); }

// DM
function openDM(){ dmWin.style.display='block'; unread=0; dmBadge.style.display='none'; dmBadge.textContent='0'; }
function chooseDM(uid){ dmTarget=uid; openDM(); const u=getUser(uid); addDM('ูุธุงู', `ุจุฏุฃุช ูุญุงุฏุซุฉ ุฎุงุตุฉ ูุน ${u?.username||uid}`, Date.now()); }
function addDM(from, text, t){ const it=el('div','item'); it.append(el('div',null,from+' ยท '+new Date(t).toLocaleTimeString())); it.append(el('div',null,text)); dmList.append(it); dmList.scrollTop=dmList.scrollHeight; }
function sendDM(){ const v=dmText.value.trim(); if(!v||!dmTarget) return; sock.emit('dm',{toUserId:dmTarget,text:v}); dmText.value=''; }

// ุฅุฏุงุฑุฉ
function openAdmin(){
  const p=$('#adminWin'); p.style.display='block';
  $('#whoami').textContent = `ุงุณูู: ${me.username} โ ุงูุฏูุฑ: ${me.role}`;
}
function doAdmin(){
  const act=$('#adminAction').value, target=$('#admTarget').value.trim();
  if(act==='clear') sock.emit('admin:clear');
  else if(act==='pin') sock.emit('admin:pin', target);
  else if(act==='kick'){ const uid=findUserId(target); if(uid) sock.emit('admin:kick', uid); }
  else if(act==='ban'){
    const uid=findUserId(target);
    if(uid) sock.emit('admin:ban', {userId:uid});
    else if(target.includes('.')) sock.emit('admin:ban',{ip:target});
    else sock.emit('admin:ban',{deviceId:target});
  } else if(act==='unban'){
    if(target.includes('.')) sock.emit('admin:unban',{ip:target});
    else sock.emit('admin:unban',{deviceId:target});
  }
  $('#admTarget').value='';
}
function findUserId(txt){
  const byName = userlist.find(u=> u.username.toLowerCase()===txt.toLowerCase());
  if(byName) return byName.userId;
  const byId = userlist.find(u=> u.userId===txt);
  return byId?.userId || null;
}

// ุฃุญุฏุงุซ
$('#btnGo').addEventListener('click', doLogin);
document.addEventListener('keydown', e=>{ if(e.key==='Enter' && login.style.display!=='none') doLogin(); });
window.addEventListener('load', ()=> $('#user').focus());
</script>
</body>
</html>
